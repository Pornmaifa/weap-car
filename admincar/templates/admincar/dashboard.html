{% extends 'admincar/admin_base.html' %}
{% load humanize %}

{% block title %}Dashboard | Admin{% endblock %}

{% block content %}

<div class="mb-8">
    <h1 class="text-3xl font-bold text-gray-800">Admin Dashboard</h1>
    <p class="text-gray-500 mt-1">‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ä‡πà‡∏≤‡∏£‡∏ñ WarpCar</p>
</div>

<div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-10">
    <div onclick="showSection('bookings', this)" id="card-bookings" class="bg-white p-6 rounded-lg shadow cursor-pointer border-b-4 border-[#17a2b8] ring-2 ring-[#17a2b8] ring-opacity-40">
        <p class="text-sm text-gray-500 font-semibold mb-1">‡∏¢‡∏≠‡∏î‡∏à‡∏≠‡∏á</p>
        <p class="text-3xl font-bold text-gray-800">{{ total_bookings|intcomma }}</p>
    </div>
    <div onclick="showSection('users', this)" id="card-users" class="bg-white p-6 rounded-lg shadow cursor-pointer border-b-4 border-transparent hover:border-[#17a2b8]">
        <p class="text-sm text-gray-500 font-semibold mb-1">‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</p>
        <p class="text-3xl font-bold text-gray-800">{{ total_users|intcomma }}</p>
    </div>
    <div onclick="showSection('cars', this)" id="card-cars" class="bg-white p-6 rounded-lg shadow cursor-pointer border-b-4 border-transparent hover:border-[#17a2b8]">
        <p class="text-sm text-gray-500 font-semibold mb-1">‡∏£‡∏ñ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>
        <p class="text-3xl font-bold text-gray-800">{{ total_cars|intcomma }}</p>
    </div>
    <div onclick="showSection('revenue', this)" id="card-revenue" class="bg-white p-6 rounded-lg shadow cursor-pointer border-b-4 border-transparent hover:border-[#17a2b8]">
        <p class="text-sm text-gray-500 font-semibold mb-1">‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ</p>
        <p class="text-3xl font-bold text-green-600">{{ total_revenue|intcomma }} ‡∏ø</p>
    </div>
</div>

<div class="bg-white rounded-lg shadow p-6 ">

    <div id="section-bookings" class="tab-content">
        <div class="flex justify-between items-center mb-4 border-l-4 border-[#17a2b8] pl-3">
            <h2 class="text-xl font-bold">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h2>
            <button onclick="toggleChart('chart-container-bookings')" class="text-sm bg-gray-100 hover:bg-gray-200 text-gray-600 px-3 py-1 rounded transition">
                <i class="fas fa-chart-line mr-1"></i> ‡∏î‡∏π‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°
            </button>
        </div>

        <div id="chart-container-bookings" class="hidden mb-6 p-4 bg-gray-50 rounded-lg border border-gray-200">
            <h3 class="text-sm font-bold text-gray-500 mb-2">‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á 6 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h3>
            <div class="h-64"><canvas id="bookingsChart"></canvas></div>
        </div>

        <div class="overflow-x-auto">
            <table class="w-full text-sm">
                <thead class="bg-gray-50 text-gray-600 uppercase">
                    <tr>
                        <th class="p-3 text-left">Ref</th>
                        <th class="p-3 text-left">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</th> 
                        <th class="p-3 text-left">‡∏£‡∏ñ‡∏ó‡∏µ‡πà‡∏à‡∏≠‡∏á</th>
                        <th class="p-3 text-left">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                        <th class="p-3 text-left">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                    </tr>
                </thead>
                <tbody class="divide-y">
                    {% for b in all_bookings %}
                    <tr class="hover:bg-gray-50 align-top">
                        <td class="p-3 font-mono text-gray-500 pt-4">{{ b.booking_ref }}</td>
                        
                        <td class="p-3">
                            <div class="flex flex-col">
                                <span class="font-bold text-gray-800 text-base">
                                    {% if b.user %}
                                        {{ b.user.first_name }} {{ b.user.last_name }}
                                    {% else %}
                                        {{ b.guest.first_name }} {{ b.guest.last_name }}
                                    {% endif %}
                                </span>
                                <span class="text-xs text-gray-500 mt-1">
                                    {% if b.user %}
                                        <i class="fas fa-user-check text-blue-500 mr-1"></i> ‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å ({{ b.user.username }})
                                    {% else %}
                                        <i class="fas fa-user-clock text-orange-500 mr-1"></i> ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ (Guest)
                                    {% endif %}
                                </span>
                            </div>
                        </td>

                        <td class="p-3 pt-4">{{ b.car.brand }} {{ b.car.model }}<br><span class="text-xs text-gray-400">{{ b.car.license_plate }}</span></td>
                        <td class="p-3 pt-4">{{ b.created_at|date:"d/m/Y" }}</td>
                        <td class="p-3 pt-4">
                            <span class="px-2 py-1 rounded text-xs font-bold
                                {% if b.status == 'confirmed' %}bg-green-100 text-green-700
                                {% elif b.status == 'pending' %}bg-yellow-100 text-yellow-700
                                {% else %}bg-gray-100 text-gray-700{% endif %}">
                                {{ b.get_status_display }}
                            </span>
                        </td>
                    </tr>
                    {% empty %}
                    <tr><td colspan="5" class="p-6 text-center text-gray-400">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <div id="section-users" class="tab-content hidden">
        <div class="flex justify-between items-center mb-4 border-l-4 border-[#17a2b8] pl-3">
            <h2 class="text-xl font-bold">‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h2>
            <button onclick="toggleChart('chart-container-users')" class="text-sm bg-gray-100 hover:bg-gray-200 text-gray-600 px-3 py-1 rounded transition">
                <i class="fas fa-chart-pie mr-1"></i> ‡∏î‡∏π‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô
            </button>
        </div>

        <div id="chart-container-users" class="hidden mb-6 p-4 bg-gray-50 rounded-lg border border-gray-200 flex justify-center">
            <div class="w-64 h-64"><canvas id="usersChart"></canvas></div>
        </div>

        <table class="w-full text-sm">
            <thead class="bg-gray-50 text-gray-600 uppercase">
                <tr>
                    <th class="p-3 text-left">Username</th>
                    <th class="p-3 text-left">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th>
                    <th class="p-3 text-left">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                    <th class="p-3 text-right">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th> </tr>
            </thead>
            <tbody class="divide-y">
                {% for u in all_users %}
                <tr class="hover:bg-gray-50 group">
                    <td class="p-3">
                        <a href="{% url 'public_profile' u.id %}" target="_blank" class="font-bold text-[#17a2b8] hover:underline flex items-center gap-2">
                            {{ u.username }} 
                            <i class="fas fa-external-link-alt text-[10px] opacity-0 group-hover:opacity-100 transition-opacity"></i>
                        </a>
                        <span class="text-xs text-gray-400">{{ u.email }}</span>
                    </td>
                    <td class="p-3">{{ u.first_name }} {{ u.last_name }}</td>
                    <td class="p-3">
                        {% if u.is_superuser %}
                            <span class="text-xs bg-purple-100 text-purple-700 px-2 py-1 rounded">Super Admin</span>
                        {% elif u.is_staff %}
                            <span class="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded">Admin (Staff)</span>
                        {% else %}
                            <span class="text-xs bg-green-100 text-green-700 px-2 py-1 rounded">‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</span>
                        {% endif %}
                    </td>
                    
                    <td class="p-3 text-right">
                        {% if not u.is_superuser and u != request.user %} 
                            <form action="{% url 'delete_user' u.id %}" method="POST" onsubmit="return confirm('‚ö†Ô∏è ‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô: ‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ {{ u.username }} ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà? \n‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡∏≠‡∏≤‡∏à‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏•‡∏Å‡∏£‡∏∞‡∏ó‡∏ö');" class="inline-block">
                                {% csrf_token %}
                                <button type="submit" class="text-gray-400 hover:text-red-600 hover:bg-red-50 p-2 rounded-full transition" title="‡∏•‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </form>
                        {% else %}
                            <span class="text-gray-300 text-xs">-</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div id="section-cars" class="tab-content hidden">
        <div class="flex justify-between items-center mb-4 border-l-4 border-[#17a2b8] pl-3">
            <h2 class="text-xl font-bold">‡∏£‡∏ñ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</h2>
            <button onclick="toggleChart('chart-container-cars')" class="text-sm bg-gray-100 hover:bg-gray-200 text-gray-600 px-3 py-1 rounded transition">
                <i class="fas fa-chart-bar mr-1"></i> ‡∏î‡∏π‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
            </button>
        </div>
        <div id="chart-container-cars" class="hidden mb-6 p-4 bg-gray-50 rounded-lg border border-gray-200">
             <div class="h-64"><canvas id="carsChart"></canvas></div>
        </div>
        <table class="w-full text-sm">
            <thead class="bg-gray-50 text-gray-600 uppercase">
                <tr><th class="p-3 text-left">‡∏£‡∏ñ</th><th class="p-3 text-left">‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</th><th class="p-3 text-left">‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏£‡∏ñ</th><th class="p-3 text-left">‡∏£‡∏≤‡∏Ñ‡∏≤/‡∏ß‡∏±‡∏ô</th><th class="p-3 text-left">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th></tr>
            </thead>
            <tbody class="divide-y">
                {% for c in all_cars %}
                <tr class="hover:bg-gray-50">
                    <td class="p-3 font-bold">{{ c.brand }} {{ c.model }}</td>
                    <td class="p-3">{{ c.license_plate }}</td>
                    <td class="p-3">
                        {% if c.owner %}
                            <div class="text-gray-800">{{ c.owner.first_name }} {{ c.owner.last_name }}</div>
                            <div class="text-xs text-gray-400">@{{ c.owner.username }}</div>
                        {% else %}
                            <span class="text-gray-400 italic">‡∏£‡∏∞‡∏ö‡∏ö (WarpCar)</span>
                        {% endif %}
                        <a href="{% url 'car_detail' c.id %}" target="_blank" class="font-bold text-gray-800 hover:text-[#17a2b8] hover:underline flex items-center gap-2">
                            {{ c.brand }} {{ c.model }}
                            <i class="fas fa-eye text-xs text-gray-400 opacity-0 group-hover:opacity-100 transition-opacity"></i>
                        </a>
                    </td>
                    <td class="p-3">{{ c.price_per_day|intcomma }}</td>
                    <td class="p-3">
                        <span class="text-xs px-2 py-1 rounded 
                            {% if c.status == 'AVAILABLE' or c.status == 'available' %}bg-green-100 text-green-700
                            {% elif c.status == 'MAINTENANCE' or c.status == 'maintenance' %}bg-yellow-100 text-yellow-800
                            {% elif c.status == 'PENDING' or c.status == 'pending' %}bg-orange-100 text-orange-800
                            {% else %}bg-red-100 text-red-700{% endif %}">
                            
                            {% if c.status == 'AVAILABLE' or c.status == 'available' %}‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
                            {% elif c.status == 'MAINTENANCE' or c.status == 'maintenance' %}‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á
                            {% elif c.status == 'PENDING' or c.status == 'pending' %}‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥
                            {% elif c.status == 'BOOKED' or c.status == 'booked' %}‡∏ñ‡∏π‡∏Å‡∏à‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß
                            {% else %}{{ c.get_status_display }}{% endif %}
                        </span>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div id="section-revenue" class="tab-content hidden">
        <div class="flex justify-between items-center mb-4 border-l-4 border-[#17a2b8] pl-3">
            <h2 class="text-xl font-bold">‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏ó‡∏µ‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß</h2>
            <button onclick="toggleChart('chart-container-revenue')" class="text-sm bg-gray-100 hover:bg-gray-200 text-gray-600 px-3 py-1 rounded transition">
                <i class="fas fa-chart-area mr-1"></i> ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ
            </button>
        </div>
        <div id="chart-container-revenue" class="hidden mb-6 p-4 bg-gray-50 rounded-lg border border-gray-200">
            <h3 class="text-sm font-bold text-gray-500 mb-2">‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</h3>
            <div class="h-64"><canvas id="revenueChart"></canvas></div>
        </div>
        <table class="w-full text-sm">
            <thead class="bg-gray-50 text-gray-600 uppercase">
                <tr><th class="p-3 text-left">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th class="p-3 text-left">Booking</th><th class="p-3 text-left">‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô</th><th class="p-3 text-left">‡∏ß‡∏¥‡∏ò‡∏µ‡∏ä‡∏≥‡∏£‡∏∞</th></tr>
            </thead>
            <tbody class="divide-y">
                {% for p in all_payments %}
                <tr class="hover:bg-gray-50">
                    <td class="p-3">{{ p.payment_date|date:"d/m/Y H:i" }}</td>
                    <td class="p-3 font-mono">{{ p.booking.booking_ref }}</td>
                    <td class="p-3 font-bold text-green-600">+{{ p.amount|intcomma }}</td>
                    <td class="p-3">{{ p.payment_method }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

</div>

{% endblock %}

{% block extra_js %}
{{ month_labels|json_script:"month_labels_data" }}
{{ booking_data|json_script:"booking_data_data" }}
{{ revenue_data|json_script:"revenue_data_data" }}
{{ user_pie_data|json_script:"user_pie_data_data" }}
{{ car_status_data|json_script:"car_status_data_data" }}

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
function toggleChart(containerId) {
    const el = document.getElementById(containerId);
    el.classList.toggle('hidden');
}

function showSection(section, card) {
    document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
    document.getElementById('section-' + section).classList.remove('hidden');
    document.querySelectorAll('[id^="card-"]').forEach(el => {
        el.classList.remove('border-[#17a2b8]', 'ring-2', 'ring-[#17a2b8]', 'ring-opacity-40');
        el.classList.add('border-transparent');
    });
    card.classList.remove('border-transparent');
    card.classList.add('border-[#17a2b8]', 'ring-2', 'ring-[#17a2b8]', 'ring-opacity-40');
}

document.addEventListener('DOMContentLoaded', function() {
    // ‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å Django View
    const monthLabels = JSON.parse(document.getElementById('month_labels_data').textContent);
    const bookingData = JSON.parse(document.getElementById('booking_data_data').textContent);
    const revenueData = JSON.parse(document.getElementById('revenue_data_data').textContent);
    const userData = JSON.parse(document.getElementById('user_pie_data_data').textContent);
    const carData = JSON.parse(document.getElementById('car_status_data_data').textContent);

    // Chart 1: Bookings
    new Chart(document.getElementById('bookingsChart'), {
        type: 'line',
        data: {
            labels: monthLabels,
            datasets: [{ label: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á', data: bookingData, borderColor: '#17a2b8', backgroundColor: 'rgba(23, 162, 184, 0.2)', fill: true, tension: 0.4 }]
        }, options: { responsive: true, maintainAspectRatio: false }
    });

    // Chart 2: Users (‚úÖ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏µ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ)
    new Chart(document.getElementById('usersChart'), {
        type: 'doughnut',
        data: {
            labels: ['Admin', '‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å', '‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ'], 
            datasets: [{ 
                data: userData, 
                // üü£ ‡∏°‡πà‡∏ß‡∏á (Admin), üü¢ ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß (Member), üü† ‡∏™‡πâ‡∏° (Guest)
                backgroundColor: ['#9333ea', '#22c55e', '#f97316'] 
            }]
        }, options: { responsive: true, maintainAspectRatio: false }
    });

    // Chart 3: Cars
    new Chart(document.getElementById('carsChart'), {
        type: 'bar',
        data: {
            labels: ['‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô', '‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏á', '‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á'],
            datasets: [{ label: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏ñ', data: carData, backgroundColor: ['#22c55e', '#ef4444', '#f59e0b'] }]
        }, options: { responsive: true, maintainAspectRatio: false }
    });

    // Chart 4: Revenue
    new Chart(document.getElementById('revenueChart'), {
        type: 'line',
        data: {
            labels: monthLabels,
            datasets: [{ label: '‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ', data: revenueData, borderColor: '#16a34a', backgroundColor: 'rgba(22, 163, 74, 0.2)', fill: true, tension: 0.3 }]
        }, options: { responsive: true, maintainAspectRatio: false }
    });
});
</script>
{% endblock %}