{% load humanize %}
{% load i18n %} {% block content %}
{% include 'car_rental/navbar_detail.html' %}

<div class="max-w-4xl mx-auto px-4 py-10 font-sarabun">
    {% if booking.status == 'approved' and booking.payment.payment_status == 'PENDING' %}
        <div class="bg-red-50 border-l-4 border-red-500 p-4 mb-6 rounded-r shadow-sm flex items-start">
            <div class="flex-shrink-0">
                <i class="fas fa-exclamation-circle text-red-500 text-xl mt-1"></i>
            </div>
            <div class="ml-3">
                <h3 class="text-lg font-bold text-red-800">{% trans "การชำระเงินไม่ผ่านการตรวจสอบ" %}</h3>
                <p class="text-red-700 mt-1">
                    {% trans "กรุณาตรวจสอบยอดเงินและอัปโหลดหลักฐานการโอนเงินใหม่อีกครั้ง" %}
                </p>
                
                <div class="mt-3">
                    <a href="{% url 'payment_page' booking.id %}" class="text-lg font-bold text-red-800">
                         {% trans "ส่งหลักฐานใหม่" %}
                    </a>
                </div>
            </div>
        </div>
    {% endif %}


    {% if booking.status == 'rejected' or booking.status == 'cancelled' %}
        <div class="bg-gray-100 border-l-4 border-gray-500 p-4 mb-6 rounded-r">
            <div class="flex">
                <div class="flex-shrink-0">
                    <i class="fas fa-times-circle text-gray-500 text-xl"></i>
                </div>
                <div class="ml-3">
                    <h3 class="text-lg font-medium text-gray-800">
                        {% if booking.status == 'cancelled' %}
                            {% trans "รายการนี้ถูกยกเลิกแล้ว" %}
                            {% if booking.payment.payment_status != 'REFUNDED' %}
                                <p class="text-sm text-gray-500 mt-1">{% trans "(ไม่มีการคืนเงิน)" %}</p>
                            {% endif %}
                    
                        {% else %}
                            {% trans "รายการจองถูกปฏิเสธ" %}
                        {% endif %} {# ปิดเงื่อนไข status == 'cancelled' #}
                        
                    </h3>
                </div>
            </div>
        </div>
    {% endif %}

    <div class="bg-white shadow overflow-hidden sm:rounded-lg border border-gray-200">
        <div class="px-4 py-5 sm:px-6 flex justify-between items-center bg-gray-50">
            <div>
                <h3 class="text-lg leading-6 font-medium text-gray-900">
                    {% trans "รายละเอียดการจอง:" %} {{ booking.booking_ref }}
                </h3>
                <p class="mt-1 max-w-2xl text-sm text-gray-500">
                    {% trans "สถานะ:" %} 
                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full 
                        {% if booking.status == 'confirmed' or booking.status == 'completed' %}bg-green-100 text-green-800
                        {% elif booking.status == 'approved' %}bg-blue-100 text-blue-800
                        {% elif booking.status == 'waiting_verify' %}bg-orange-100 text-orange-800
                        {% elif booking.status == 'rejected' or booking.status == 'cancelled' %}bg-red-100 text-red-800
                        {% else %}bg-yellow-100 text-yellow-800{% endif %}">
                        {{ booking.get_status_display }}
                    </span>
                </p>
            </div>
            <a href="/" class="text-blue-600 hover:text-blue-900 text-sm">{% trans "กลับหน้าหลัก" %}</a>
        </div>

        <div class="border-t border-gray-200">
            <dl>
                <div class="bg-white px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
                    <dt class="text-sm font-medium text-gray-500">{% trans "รถที่เช่า" %}</dt>
                    <dd class="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2">
                        {{ booking.car.brand }} {{ booking.car.model }} ({{ booking.car.license_plate }})
                    </dd>
                </div>

                <div class="bg-gray-50 px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
                    <dt class="text-sm font-medium text-gray-500">{% trans "วันรับรถ - คืนรถ" %}</dt>
                    <dd class="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2">
                        {{ booking.pickup_datetime|date:"d M Y H:i" }} - {{ booking.dropoff_datetime|date:"d M Y H:i" }}
                    </dd>
                </div>

                <div class="bg-white px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
                    <dt class="text-sm font-medium text-gray-500">{% trans "ชื่อผู้จอง" %}</dt>
                    <dd class="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2">
                        {% if booking.user %}
                            {{ booking.user.first_name }} {{ booking.user.last_name }} (Member)
                        {% else %}
                            {{ booking.guest.first_name }} {{ booking.guest.last_name }} (Guest)
                        {% endif %}
                    </dd>
                </div>

                <div class="bg-gray-50 px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
                    <dt class="text-sm font-medium text-gray-500">{% trans "การชำระเงิน" %}</dt>
                    <dd class="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2">
                        <p>{% trans "ค่าเช่ารวม:" %} <strong>{{ booking.total_price|intcomma }} THB</strong></p>
                        <p class="text-green-600">{% trans "มัดจำที่ต้องจ่าย (15%):" %} <strong>{{ booking.deposit_amount|intcomma }} THB</strong></p>
                        <p class="text-red-600 text-xs mt-1">{% trans "*ส่วนที่เหลือจ่ายวันรับรถ" %}
                            <strong>
                                {% if booking.remaining_balance %} 
                                    {{ booking.remaining_balance|intcomma }} 
                                {% else %}
                                    - {% trans "คำนวณหน้างาน" %} -
                                {% endif %}
                                THB
                            </strong>
                        </p>
                    </dd>
                </div>
            </dl>
        </div>

        <div class="px-4 py-4 bg-gray-100 border-t border-gray-200 flex justify-end items-center gap-3">
            
            {% if booking.status == 'pending' %}
                <span class="text-yellow-600 text-sm flex items-center mr-auto">
                    <i class="fas fa-hourglass-half mr-2"></i> {% trans "รอเจ้าของรถอนุมัติ..." %}
                </span>
                <a href="{% url 'cancel_now' booking.id %}" 
                onclick="return confirm('{% trans 'ยืนยันการยกเลิกคำขอจองนี้?' %}');"
                class="text-gray-500 hover:text-red-600 text-xs underline transition">
                    {% trans "ยกเลิกคำขอจอง" %}
                </a>

            {% elif booking.status == 'approved' %}
                <span class="text-sm text-gray-500 mr-2">{% trans "เจ้าของรถอนุมัติแล้ว กรุณาชำระเงิน" %}</span>
                
                <a href="{% url 'cancel_now' booking.id %}" 
                onclick="return confirm('{% trans 'คุณยังไม่ได้ชำระเงิน ยืนยันการยกเลิกรายการจองนี้?' %}');"
                class="text-red-500 hover:text-red-700 text-xs underline mr-4 transition">
                    {% trans "ยกเลิกรายการ" %}
                </a>

                <a href="{% url 'payment_page' booking.id %}" class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none">
                    <i class="fas fa-file-invoice-dollar mr-2"></i> {% trans "แจ้งชำระเงิน" %}
                </a>

            {% elif booking.status == 'waiting_verify' %}
                <span class="text-orange-600 text-sm flex items-center">
                    <i class="fas fa-search-dollar mr-2"></i> {% trans "แจ้งโอนแล้ว รอตรวจสอบสลิป" %}
                </span>

            {% elif booking.status == 'confirmed' %}
                <div class="flex items-center gap-4">
                    <span class="text-green-600 text-sm flex items-center font-bold">
                        <i class="fas fa-check-circle mr-2"></i> {% trans "จองสำเร็จ! เตรียมเอกสารรับรถได้เลย" %}
                    </span>
                    
                    <a href="{% url 'request_refund' booking.id %}" 
                    class="text-red-500 hover:text-red-700 text-xs underline font-medium border border-red-200 hover:bg-red-50 px-2 py-1 rounded transition">
                        {% trans "แจ้งยกเลิก/ขอคืนเงิน" %}
                    </a>
                </div>

            {% elif booking.status == 'refund_requested' %}
                <span class="text-purple-600 text-sm flex items-center font-bold">
                    <i class="fas fa-undo-alt mr-2"></i> {% trans "กำลังดำเนินการคืนเงิน..." %}
                </span>

            {% elif booking.status == 'rejected' %}
                <span class="text-red-600 text-sm flex items-center font-bold">
                    <i class="fas fa-times-circle mr-2"></i> {% trans "การจองถูกปฏิเสธ" %}
                </span>
            {% endif %}
        </div>

        {% if booking.status == 'picked_up' or booking.status == 'completed' %}
        <div class="border-t border-gray-200 px-4 py-5 bg-white">
            <h4 class="text-sm font-medium text-gray-500 mb-3">{% trans "หลักฐานสภาพรถ (ส่งโดยเจ้าของรถ)" %}</h4>
            
            {% if booking.inspections.all %}
                <div class="grid grid-cols-2 sm:grid-cols-4 gap-4">
                    {% for item in booking.inspections.all %}
                        {% if item.image %}
                        <div class="relative group">
                            <a href="{{ item.image.url }}" target="_blank">
                                <img src="{{ item.image.url }}" class="w-full h-24 object-cover rounded-md border shadow-sm hover:opacity-75 transition">
                            </a>
                            <p class="text-[10px] text-center mt-1 truncate">{{ item.description|default:"-" }}</p>
                        </div>
                        {% endif %}
                    {% endfor %}
                </div>
            {% else %}
                <p class="text-sm text-gray-400 italic">{% trans "- ไม่มีรูปภาพ -" %}</p>
            {% endif %}

            {% if booking.status == 'completed' %}
                <div class="mt-4 pt-4 border-t border-gray-100 text-center text-green-600 font-bold">
                    <i class="fas fa-flag-checkered mr-2"></i> {% trans "จบการเช่าเรียบร้อยแล้ว" %}
                </div>
            {% endif %}
        </div>
        {% endif %}

    </div>
</div>


{% endblock %}