{% extends 'basereview.html' %}{% load static %}
{% load humanize %}

{% block content %}
<body class="bg-gray-100 font-sarabun">

    {% include 'car_rental/navbar_detail.html' %}

    <div class="container mx-auto flex flex-col md:flex-row p-4 md:p-8 gap-8">
        {% include 'users/sidebar.html' %} 
        
        <main class="flex-1 p-4 md:p-8">
            
            <h1 class="text-3xl font-bold text-gray-800 mb-6">จัดการรายการจองทั้งหมด</h1>

            <div class="bg-white rounded-lg shadow-lg overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full text-left border-collapse">
                        <thead>
                            <tr class="bg-gray-50 text-gray-600 text-sm uppercase">
                                <th class="p-4 border-b">รถที่จอง</th>
                                <th class="p-4 border-b">ผู้เช่า</th>
                                <th class="p-4 border-b">สถานะ</th> <th class="p-4 border-b">วันใช้งาน</th>
                                <th class="p-4 border-b text-center">จัดการ</th>
                                </tr>
                        </thead>
                        <tbody class="text-gray-700">
                            {% for booking in bookings %}
                            <tr class="hover:bg-blue-50 transition border-b last:border-b-0">
                                
                                <td class="p-4 flex items-center gap-3">
                                    {% if booking.car.images.first %}
                                        <img src="{{ booking.car.images.first.image.url }}" class="w-12 h-12 rounded object-cover">
                                    {% endif %}
                                    <div>
                                        <div class="font-bold">{{ booking.car.brand }} {{ booking.car.model }}</div>
                                        <div class="text-xs text-gray-500">Ref: {{ booking.booking_ref }}</div>
                                    </div>
                                </td>

                                <td class="p-4">
                                    <button type="button" onclick="openDetailModal(this)" 
                                        class="group text-left focus:outline-none"
                                        
                                       
                                        data-status="{{ booking.status }}"
                                        
                                        data-id="{{ booking.id }}"
                                        data-ref="{{ booking.booking_ref }}" 
                                        data-name="{% if booking.user %}{{ booking.user.first_name }} {{ booking.user.last_name }}{% else %}{{ booking.guest.first_name }} {{ booking.guest.last_name }}{% endif %}"
                                        data-phone="{% if booking.user %}{{ booking.user.profile.phone|default:'-' }}{% else %}{{ booking.guest.phone_number }}{% endif %}"
                                        data-email="{% if booking.user %}{{ booking.user.email }}{% else %}{{ booking.guest.email }}{% endif %}"
                                        data-license="{% if booking.user %}{{ booking.user.profile.license_number|default:'-' }}{% else %}{{ booking.guest.license_number }}{% endif %}"
                                        data-profile-url="{% if booking.user %}{% url 'public_profile' booking.user.id %}{% endif %}"
                                        data-car="{{ booking.car.brand }} {{ booking.car.model }}"
                                        data-plate="{{ booking.car.license_plate }}"
                                        data-pickup="{{ booking.pickup_datetime|date:'d M Y, H:i' }}"
                                        data-dropoff="{{ booking.dropoff_datetime|date:'d M Y, H:i' }}"
                                        data-location="{{ booking.location }}"
                                        data-total="{{ booking.total_price }}"
                                        data-approve-url="{% url 'update_booking_status' booking.id 'approve' %}"
                                        data-reject-url="{% url 'update_booking_status' booking.id 'reject' %}"
                                    >
                                        <div class="font-semibold text-gray-800 group-hover:text-[#47B3C4] transition flex items-center gap-1">
                                            {% if booking.user %}
                                                <a href="{% url 'public_profile' booking.user.id %}" target="_blank" onclick="event.stopPropagation()" class="hover:underline flex items-center gap-1 z-10 relative">
                                                    {{ booking.user.first_name }} {{ booking.user.last_name }}
                                                    <i class="fas fa-external-link-alt text-[10px] text-gray-400 ml-1"></i>
                                                </a>
                                            {% else %}
                                                {{ booking.guest.first_name }} {{ booking.guest.last_name }}
                                            {% endif %}
                                            <i class="fas fa-search-plus text-xs opacity-0 group-hover:opacity-100 transition-opacity"></i>
                                        </div>
                                        <div class="text-[10px] text-[#47B3C4] mt-1 group-hover:underline">คลิกดูรายละเอียด</div>
                                    </button>
                                </td>

                                <td class="p-4">
                                    {% if booking.status == 'pending' %}
                                        <span class="bg-yellow-100 text-yellow-700 px-2 py-1 rounded text-xs font-bold">รออนุมัติ</span>
                                    {% elif booking.status == 'approved' %}
                                        <span class="bg-blue-100 text-blue-700 px-2 py-1 rounded text-xs font-bold">รอชำระเงิน</span>
                                    {% elif booking.status == 'confirmed' %}
                                        <span class="bg-green-100 text-green-700 px-2 py-1 rounded text-xs font-bold">จ่ายเงินแล้ว</span>
                                    {% elif booking.status == 'picked_up' %}
                                        <span class="bg-purple-100 text-purple-700 px-2 py-1 rounded text-xs font-bold">รับรถแล้ว</span>
                                    {% elif booking.status == 'completed' %}
                                        <span class="bg-gray-200 text-gray-600 px-2 py-1 rounded text-xs font-bold">จบงาน</span>
                                    {% else %}
                                        <span class="bg-red-100 text-red-600 px-2 py-1 rounded text-xs font-bold">ยกเลิก/ปฏิเสธ</span>
                                    {% endif %}
                                </td>

                                <td class="p-4 text-sm">
                                    <div><span class="text-gray-400">รับ:</span> {{ booking.pickup_datetime|date:"d M H:i" }}</div>
                                    <div><span class="text-gray-400">คืน:</span> {{ booking.dropoff_datetime|date:"d M H:i" }}</div>
                                </td>

                                <td class="p-4 text-center">
    
                                    {% if booking.status == 'confirmed' %}
                                        <a href="{% url 'inspection_page' booking.id %}" 
                                        class="inline-block bg-gray-600 hover:bg-gray-700 text-white px-3 py-1 rounded text-xs shadow transition">
                                            <i class="fas fa-camera mr-1"></i> ตรวจรถ/ส่งมอบ
                                        </a>

                                    {% elif booking.status == 'picked_up' %}
                                        <a href="{% url 'update_booking_status' booking.id 'completed' %}" 
                                        class="inline-block bg-gray-600 hover:bg-gray-700 text-white px-3 py-1 rounded text-xs shadow transition"
                                        onclick="return confirm('ยืนยันรับรถคืนและจบงาน?');">
                                            <i class="fas fa-flag-checkered mr-1"></i> จบงาน
                                        </a>
                                    
                                    {% elif booking.status == 'pending' %}
                                        <span class="text-xs text-yellow-600">กดที่ชื่อเพื่ออนุมัติ</span>

                                    {% elif booking.status == 'completed' %}
                                        
                                        {% if not booking.renter_review %}
                                            <button onclick="openReviewModal('{{ booking.id }}', '{{ booking.user.first_name }} {{ booking.user.last_name }}', 'renter')" 
                                                class="bg-blue-400 text-white px-3 py-1 rounded text-xs hover:bg-blue-500 ml-2 shadow transition">
                                                <i class="fas fa-user-check mr-1"></i> รีวิวลูกค้า
                                            </button>
                                        {% else %}
                                            <div class="text-xs text-green-600 font-bold mt-1">
                                                <i class="fas fa-check-circle mr-1"></i> รีวิวลูกค้าแล้ว
                                                <span class="text-gray-400 font-normal">({{ booking.renter_review.rating }}/5)</span>
                                            </div>
                                        {% endif %}

                                    {% else %}
                                        <span class="text-xs text-gray-400">-</span>
                                    {% endif %}

                                </td>

                            </tr>
                            {% empty %}
                            <tr><td colspan="5" class="p-8 text-center text-gray-400">ยังไม่มีประวัติการจอง</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <div id="detailModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4 backdrop-blur-sm transition-opacity">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl overflow-hidden transform scale-95 transition-transform duration-200" id="detailModalContent">
            
            <div class="bg-[#47B3C4] px-6 py-4 flex justify-between items-center text-white">
                <div>
                    <h3 class="text-lg font-bold">รายละเอียด</h3>
                    <p class="text-sm opacity-90">Ref: <span id="modal_ref" class="font-mono font-bold"></span></p>
                </div>
                <button onclick="closeDetailModal()" class="text-white hover:text-gray-200 text-2xl font-bold">&times;</button>
            </div>

            <div class="p-6 overflow-y-auto max-h-[70vh]">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div class="bg-gray-50 p-4 rounded-lg border border-gray-100">
                        <div class="flex justify-between items-center border-b pb-2 mb-3">
                            <h4 class="text-gray-800 font-bold"><i class="fas fa-user mr-2 text-gray-400"></i>ผู้เช่า</h4>
                            
                            <a id="modal_profile_link" href="#" target="_blank" class="hidden text-xs bg-white border border-[#47B3C4] text-[#47B3C4] px-2 py-1 rounded hover:bg-[#47B3C4] hover:text-white transition shadow-sm">
                                <i class="fas fa-star mr-1"></i> ดูรีวิวลูกค้า
                            </a>
                        </div>
                        <p class="text-sm">ชื่อ: <span id="modal_name" class="font-medium"></span></p>
                        <p class="text-sm mt-1">เบอร์: <span id="modal_phone" class="font-medium"></span></p>
                        <p class="text-sm mt-1">Email: <span id="modal_email" class="font-medium"></span></p>
                        <p class="text-sm mt-1">ใบขับขี่: <span id="modal_license" class="font-medium"></span></p>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-lg border border-gray-100">
                        <h4 class="text-gray-800 font-bold mb-3 border-b pb-1"><i class="fas fa-car mr-2 text-gray-400"></i>ข้อมูลการเช่า</h4>
                        <p class="text-sm">รถ: <span id="modal_car" class="font-medium"></span></p>
                        <p class="text-xs text-gray-400 mb-2">(<span id="modal_plate"></span>)</p>
                        <p class="text-xs">รับ: <span id="modal_pickup" class="font-medium"></span></p>
                        <p class="text-xs">คืน: <span id="modal_dropoff" class="font-medium"></span></p>
                        <p class="text-xs mt-1">สถานที่: <span id="modal_location" class="font-medium"></span></p>
                    </div>
                </div>

                <div class="bg-white border-2 border-dashed border-[#47B3C4] rounded-lg p-4 mb-6">
                    <h4 class="text-center text-gray-600 font-bold mb-4">สรุปรายได้</h4>
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-gray-600">ยอดชำระ</span>
                        <span class="font-bold text-lg" id="modal_total"></span>
                    </div>
                    <div class="flex justify-between items-center mb-2 text-red-500 text-sm">
                        <span>หักค่าธรรมเนียม (15%)</span>
                        <span id="modal_fee"></span>
                    </div>
                    <div class="border-t pt-2 flex justify-between items-center mt-2">
                        <span class="font-bold text-gray-800">รายได้สุทธิ</span>
                        <span class="text-2xl font-bold text-green-600" id="modal_net"></span>
                    </div>
                </div>
            </div>

            <div class="bg-gray-50 px-6 py-4 flex justify-end gap-3 border-t">
                <button onclick="closeDetailModal()" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-lg font-medium transition">
                    ปิด
                </button>
                
                <div id="modal_actions" class="flex gap-3 hidden">
                    <a id="btn_reject" href="#" onclick="return confirm('ยืนยันที่จะปฏิเสธ?');" class="px-4 py-2 border border-red-500 text-red-500 hover:bg-red-50 rounded-lg font-bold transition flex items-center">
                        <i class="fas fa-times mr-2"></i> ปฏิเสธ
                    </a>
                    <a id="btn_approve" href="#" class="px-6 py-2 bg-[#47B3C4] hover:bg-[#3a9faa] text-white rounded-lg font-bold shadow-lg transition flex items-center">
                        <i class="fas fa-check mr-2"></i> อนุมัติ
                    </a>
                </div>
            </div>
        </div>
    </div>

    <script>
        function openDetailModal(btn) {
            const d = btn.dataset;
            
            // ใส่ข้อมูล Text
            document.getElementById('modal_ref').innerText = '#' + d.ref;
            document.getElementById('modal_name').innerText = d.name;
            document.getElementById('modal_phone').innerText = d.phone;
            document.getElementById('modal_email').innerText = d.email;
            document.getElementById('modal_license').innerText = d.license;
            const profileLink = document.getElementById('modal_profile_link');
            if (profileLink) {
                if (d.profileUrl && d.profileUrl.trim() !== "") {
                    profileLink.href = d.profileUrl;
                    profileLink.classList.remove('hidden');
                    profileLink.style.display = 'inline-flex';
                } else {
                    profileLink.classList.add('hidden');
                    profileLink.style.display = 'none';
                }
            }
            // ลิงก์รีวิวลูกค้า
            document.getElementById('modal_car').innerText = d.car;
            document.getElementById('modal_plate').innerText = d.plate;
            document.getElementById('modal_pickup').innerText = d.pickup;
            document.getElementById('modal_dropoff').innerText = d.dropoff;
            document.getElementById('modal_location').innerText = d.location;

            // คำนวณเงิน
            const total = parseFloat(d.total);
            const fee = total * 0.15;
            const net = total - fee;
            const fmt = (num) => '฿' + num.toLocaleString('th-TH', {minimumFractionDigits: 2, maximumFractionDigits: 2});

            document.getElementById('modal_total').innerText = fmt(total);
            document.getElementById('modal_fee').innerText = '-' + fmt(fee);
            document.getElementById('modal_net').innerText = fmt(net);

            // ✅ Logic ซ่อน/แสดง ปุ่มอนุมัติ
            const actionDiv = document.getElementById('modal_actions');
            if (d.status === 'pending') {
                actionDiv.classList.remove('hidden'); // โชว์ปุ่มถ้าเป็น Pending
                document.getElementById('btn_approve').href = d.approveUrl;
                document.getElementById('btn_reject').href = d.rejectUrl;
            } else {
                actionDiv.classList.add('hidden'); // ซ่อนปุ่มถ้าสถานะอื่น (เพราะจัดการหน้าตารางเอา)
            }

            // เปิด Modal
            const modal = document.getElementById('detailModal');
            const content = document.getElementById('detailModalContent');
            modal.classList.remove('hidden');
            setTimeout(() => {
                content.classList.remove('scale-95');
                content.classList.add('scale-100');
            }, 10);
        }

        function closeDetailModal() {
            const modal = document.getElementById('detailModal');
            const content = document.getElementById('detailModalContent');
            content.classList.remove('scale-100');
            content.classList.add('scale-95');
            setTimeout(() => { modal.classList.add('hidden'); }, 200);
        }
        window.onclick = function(event) {
            if (event.target == document.getElementById('detailModal')) closeDetailModal();
        }
    </script>
{% endblock %}