{% extends 'basereview.html' %}
{% load static %}
{% load humanize %}
{% load i18n %} 

{% block content %}
{% trans "ยืนยันที่จะปฏิเสธ?" as msg_confirm_reject %}
{% trans "ยืนยันรับรถคืนและจบงาน?" as msg_confirm_finish %}

<body class="bg-gray-100 font-sarabun">

    {% include 'car_rental/navbar_detail.html' %} 
    
    <div class="container mx-auto flex flex-col md:flex-row p-4 md:p-8 gap-8 pt-24">
        {% include 'users/sidebar.html' %} 
        
        <main class="flex-1 p-4 md:p-8">
            
            <h1 class="text-3xl font-bold text-gray-800 mb-6">{% trans "จัดการรายการจองทั้งหมด" %}</h1>

            <div class="bg-white rounded-lg shadow-lg overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full text-left border-collapse">
                        <thead>
                            <tr class="bg-gray-50 text-gray-600 text-sm uppercase">
                                <th class="p-4 border-b">{% trans "รถที่จอง" %}</th>
                                <th class="p-4 border-b">{% trans "ผู้เช่า" %}</th>
                                <th class="p-4 border-b">{% trans "สถานะ" %}</th> 
                                <th class="p-4 border-b">{% trans "วันใช้งาน" %}</th>
                                <th class="p-4 border-b text-center">{% trans "จัดการ" %}</th>
                            </tr>
                        </thead>
                        <tbody class="text-gray-700">
                            {% for booking in bookings %}
                            <tr class="hover:bg-blue-50 transition border-b last:border-b-0">
                                
                                <td class="p-4 flex items-center gap-3">
                                    {% if booking.car.images.first %}
                                        <img src="{{ booking.car.images.first.image.url }}" class="w-12 h-12 rounded object-cover">
                                    {% endif %}
                                    <div>
                                        <div class="font-bold">{{ booking.car.brand }} {{ booking.car.model }}</div>
                                        <div class="text-xs text-gray-500">Ref: {{ booking.booking_ref }}</div>
                                    </div>
                                </td>

                                <td class="p-4">
                                    <button type="button" onclick="openDetailModal(this)" 
                                        class="group text-left focus:outline-none"
                                        
                                        data-status="{{ booking.status }}"
                                        data-id="{{ booking.id }}"
                                        data-ref="{{ booking.booking_ref }}" 
                                        data-name="{% if booking.user %}{{ booking.user.first_name }} {{ booking.user.last_name }}{% else %}{{ booking.guest.first_name }} {{ booking.guest.last_name }}{% endif %}"
                                        data-phone="{% if booking.user %}{{ booking.user.profile.phone|default:'-' }}{% else %}{{ booking.guest.phone_number }}{% endif %}"
                                        data-email="{% if booking.user %}{{ booking.user.email }}{% else %}{{ booking.guest.email }}{% endif %}"
                                        data-license="{% if booking.user %}{{ booking.user.profile.license_no|default:'-' }}{% else %}{{ booking.guest.license_number }}{% endif %}"
                                        data-profile-url="{% if booking.user %}{% url 'public_profile' booking.user.id %}{% endif %}"
                                        
                                        data-car="{{ booking.car.brand }} {{ booking.car.model }}"
                                        data-plate="{{ booking.car.license_plate }}"
                                        
                                        /* ✅ กลับมาใช้ date filter ปกติ */
                                        data-pickup="{{ booking.pickup_datetime|date:'d M Y, H:i' }}"
                                        data-dropoff="{{ booking.dropoff_datetime|date:'d M Y, H:i' }}"
                                        
                                        data-location="{{ booking.location }}"
                                        
                                        data-price-per-day="{{ booking.car.price_per_day }}"
                                        data-days="{{ booking.rental_days }}"
                                        data-discount="{{ booking.discount_amount }}"
                                        data-deposit="{{ booking.car.deposit|default:'0' }}"
                                        
                                        data-approve-url="{% url 'update_booking_status' booking.id 'approve' %}"
                                        data-reject-url="{% url 'update_booking_status' booking.id 'reject' %}"
                                    >
                                        <div class="font-semibold text-gray-800 group-hover:text-[#47B3C4] transition flex items-center gap-1">
                                            {% if booking.user %}
                                                <span class="hover:underline flex items-center gap-1 z-10 relative">
                                                    {{ booking.user.first_name }} {{ booking.user.last_name }}
                                                </span>
                                            {% else %}
                                                {{ booking.guest.first_name }} {{ booking.guest.last_name }}
                                            {% endif %}
                                            <i class="fas fa-search-plus text-xs opacity-0 group-hover:opacity-100 transition-opacity"></i>
                                        </div>
                                        <div class="text-[10px] text-[#47B3C4] mt-1 group-hover:underline">{% trans "คลิกดูรายละเอียด" %}</div>
                                    </button>
                                </td>

                                <td class="p-4">
                                    {% if booking.status == 'pending' %}
                                        <span class="bg-yellow-100 text-yellow-700 px-2 py-1 rounded text-xs font-bold">{% trans "รออนุมัติ" %}</span>
                                    {% elif booking.status == 'approved' %}
                                        <span class="bg-blue-100 text-blue-700 px-2 py-1 rounded text-xs font-bold">{% trans "รอชำระเงิน" %}</span>
                                    {% elif booking.status == 'waiting_verify' %}
                                        <span class="text-orange-600 bg-orange-100 px-2 py-1 rounded">
                                            <i class="fas fa-search-dollar"></i> {% trans "รอตรวจสอบยอดเงิน" %}
                                        </span>   
                                    {% elif booking.status == 'confirmed' %}
                                        <span class="bg-green-100 text-green-700 px-2 py-1 rounded text-xs font-bold">{% trans "จ่ายเงินแล้ว" %}</span>
                                    {% elif booking.status == 'picked_up' %}
                                        <span class="bg-purple-100 text-purple-700 px-2 py-1 rounded text-xs font-bold">{% trans "รับรถแล้ว" %}</span>
                                    {% elif booking.status == 'completed' %}
                                        <span class="bg-gray-200 text-gray-600 px-2 py-1 rounded text-xs font-bold">{% trans "จบงาน" %}</span>
                                    {% else %}
                                        <span class="bg-red-100 text-red-600 px-2 py-1 rounded text-xs font-bold">{% trans "ยกเลิก/ปฏิเสธ" %}</span>
                                    {% endif %}
                                </td>

                                <td class="p-4 text-sm">
                                    <div><span class="text-gray-400">{% trans "รับ:" %}</span> {{ booking.pickup_datetime|date:"d M H:i" }}</div>
                                    <div><span class="text-gray-400">{% trans "คืน:" %}</span> {{ booking.dropoff_datetime|date:"d M H:i" }}</div>
                                </td>

                                <td class="p-4 text-center">
                                    {% if booking.status == 'confirmed' %}
                                        <a href="{% url 'inspection_page' booking.id %}" 
                                        class="inline-block bg-gray-600 hover:bg-gray-700 text-white px-3 py-1 rounded text-xs shadow transition">
                                            <i class="fas fa-camera mr-1"></i> {% trans "ตรวจรถ/ส่งมอบ" %}
                                        </a>
                                    {% elif booking.status == 'picked_up' %}
                                        <a href="{% url 'update_booking_status' booking.id 'completed' %}" 
                                        class="inline-block bg-gray-600 hover:bg-gray-700 text-white px-3 py-1 rounded text-xs shadow transition"
                                        onclick="return confirm('{{ msg_confirm_finish|escapejs }}');">
                                            <i class="fas fa-flag-checkered mr-1"></i> {% trans "จบงาน" %}
                                        </a>
                                    {% elif booking.status == 'pending' %}
                                        <span class="text-xs text-yellow-600">{% trans "กดที่ชื่อเพื่ออนุมัติ" %}</span>
                                    {% elif booking.status == 'completed' %}
                                        {% if booking.user %}
                                            {% if not booking.renter_review %}
                                                <button onclick="openReviewModal('{{ booking.id }}', '{{ booking.user.first_name }} {{ booking.user.last_name }}', 'renter')" 
                                                        class="bg-blue-400 text-white px-3 py-1 rounded text-xs hover:bg-blue-500 ml-2 shadow transition">
                                                    <i class="fas fa-user-check mr-1"></i> {% trans "รีวิวลูกค้า" %}
                                                </button>
                                            {% else %}
                                                <div class="text-xs text-green-600 font-bold mt-1">
                                                    <i class="fas fa-check-circle mr-1"></i> {% trans "รีวิวลูกค้าแล้ว" %}
                                                    <span class="text-gray-400 font-normal">({{ booking.renter_review.rating }}/5)</span>
                                                </div>
                                            {% endif %}
                                        {% else %}
                                            <span class="text-xs text-gray-400 italic">{% trans "ไม่มีระบบรีวิวลูกค้าทั่วไป" %}</span>
                                        {% endif %}

                                        {% else %}
                                            <span class="text-xs text-gray-400">-</span>
                                        {% endif %}
                                </td>

                            </tr>
                            {% empty %}
                            <tr><td colspan="5" class="p-8 text-center text-gray-400">{% trans "ยังไม่มีประวัติการจอง" %}</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <div id="detailModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4 backdrop-blur-sm transition-opacity">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl overflow-hidden transform scale-95 transition-transform duration-200" id="detailModalContent">
            
            <div class="bg-[#47B3C4] px-6 py-4 flex justify-between items-center text-white">
                <div>
                    <h3 class="text-lg font-bold">{% trans "รายละเอียดคำขอเช่า" %}</h3>
                    <p class="text-sm opacity-90">Ref: <span id="modal_ref" class="font-mono font-bold"></span></p>
                </div>
                <button onclick="closeDetailModal()" class="text-white hover:text-gray-200 text-2xl font-bold">&times;</button>
            </div>

            <div class="p-6 overflow-y-auto max-h-[70vh]">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div class="bg-gray-50 p-4 rounded-lg border border-gray-100">
                        <div class="flex justify-between items-center border-b pb-2 mb-3">
                            <h4 class="text-gray-800 font-bold"><i class="fas fa-user mr-2 text-gray-400"></i>{% trans "ผู้เช่า" %}</h4>
                            
                            {% if booking.user %}
                            <a id="modal_profile_link" href="#" target="_blank" class="hidden text-xs bg-white border border-[#47B3C4] text-[#47B3C4] px-2 py-1 rounded hover:bg-[#47B3C4] hover:text-white transition shadow-sm">
                                <i class="fas fa-star mr-1"></i> {% trans "ดูรีวิวลูกค้า" %}
                            </a>
                            {% endif %}
                        </div>
                        <p class="text-sm">{% trans "ชื่อ:" %} <span id="modal_name" class="font-medium"></span></p>
                        <p class="text-sm mt-1">{% trans "เบอร์:" %} <span id="modal_phone" class="font-medium"></span></p>
                        <p class="text-sm mt-1">Email: <span id="modal_email" class="font-medium"></span></p>
                        <p class="text-sm mt-1">{% trans "ใบขับขี่:" %} <span id="modal_license" class="font-medium"></span></p>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-lg border border-gray-100">
                        <h4 class="text-gray-800 font-bold mb-3 border-b pb-1"><i class="fas fa-car mr-2 text-gray-400"></i>{% trans "ข้อมูลการเช่า" %}</h4>
                        <p class="text-sm">{% trans "รถ:" %} <span id="modal_car" class="font-medium"></span></p>
                        <p class="text-xs text-gray-400 mb-2">(<span id="modal_plate"></span>)</p>
                        <p class="text-xs">{% trans "รับ:" %} <span id="modal_pickup" class="font-medium"></span></p>
                        <p class="text-xs">{% trans "คืน:" %} <span id="modal_dropoff" class="font-medium"></span></p>
                        <p class="text-xs mt-1">{% trans "สถานที่:" %} <span id="modal_location" class="font-medium"></span></p>
                    </div>
                </div>

                <div class="bg-white border-2 border-dashed border-[#47B3C4] rounded-lg p-4 mb-6">
                    <h4 class="text-center text-gray-600 font-bold mb-4">{% trans "สรุปรายได้" %}</h4>
                    
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-gray-600">{% trans "ยอดค่าเช่าหลังหักส่วนลด" %}</span>
                        <span class="font-bold text-lg" id="modal_total"></span>
                    </div>
                    
                    <div class="flex justify-between items-center mb-2 text-yellow-600 text-sm bg-yellow-50 p-1 rounded">
                        <span><i class="fas fa-hand-holding-usd mr-1"></i> {% trans "รับมัดจำเพิ่ม (เงินสด)" %}</span>
                        <span class="font-bold" id="modal_deposit"></span>
                    </div>
                    
                    <div id="row_discount" class="flex justify-between items-center mb-2 text-green-600 text-sm hidden">
                        <span><i class="fas fa-tag mr-1"></i> {% trans "ส่วนลดโปรโมชั่น" %}</span>
                        <span id="modal_discount"></span>
                    </div>

                    <div class="flex justify-between items-center mb-2 text-red-500 text-sm">
                        <span>{% trans "หักค่าธรรมเนียมระบบ (15%)" %}</span>
                        <span id="modal_fee"></span>
                    </div>
                    
                    <div class="border-t pt-2 flex justify-between items-center mt-2">
                        <span class="font-bold text-gray-800">{% trans "รายได้สุทธิที่คุณได้รับ" %}</span>
                        <span class="text-2xl font-bold text-green-600" id="modal_net"></span>
                    </div>
                </div>
            </div>

            <div class="bg-gray-50 px-6 py-4 flex justify-end gap-3 border-t">
                <button onclick="closeDetailModal()" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-lg font-medium transition">
                    {% trans "ปิด" %}
                </button>
                
                <div id="modal_actions" class="flex gap-3 hidden">
                    <a id="btn_reject" href="#" onclick="return confirm('{{ msg_confirm_reject|escapejs }}');" class="px-4 py-2 border border-red-500 text-red-500 hover:bg-red-50 rounded-lg font-bold transition flex items-center">
                        <i class="fas fa-times mr-2"></i> {% trans "ปฏิเสธ" %}
                    </a>
                    <a id="btn_approve" href="#" class="px-6 py-2 bg-[#47B3C4] hover:bg-[#3a9faa] text-white rounded-lg font-bold shadow-lg transition flex items-center">
                        <i class="fas fa-check mr-2"></i> {% trans "อนุมัติ" %}
                    </a>
                </div>
            </div>
        </div>
    </div>

    <script>
        function openDetailModal(btn) {
            try {
                const d = btn.dataset;

                // 1. ข้อมูลพื้นฐาน
                document.getElementById('modal_ref').innerText = '#' + (d.ref || '-');
                document.getElementById('modal_name').innerText = d.name || '-';
                document.getElementById('modal_phone').innerText = d.phone || '-';
                document.getElementById('modal_email').innerText = d.email || '-';
                document.getElementById('modal_license').innerText = d.license || '-';

                const profileLink = document.getElementById('modal_profile_link');
                if (profileLink) {
                    if (d.profileUrl && d.profileUrl.trim() !== "") {
                        profileLink.href = d.profileUrl;
                        profileLink.classList.remove('hidden');
                        profileLink.style.display = 'inline-flex';
                    } else {
                        profileLink.classList.add('hidden');
                    }
                }

                // 2. ข้อมูลรถ
                document.getElementById('modal_car').innerText = d.car || '-';
                document.getElementById('modal_plate').innerText = d.plate || '-';
                
                document.getElementById('modal_pickup').innerText = d.pickup || '-';
                document.getElementById('modal_dropoff').innerText = d.dropoff || '-';
                document.getElementById('modal_location').innerText = d.location || '-'; 

                // 3. คำนวณเงิน
                const pricePerDay = parseFloat(d.pricePerDay || 0);
                const days = parseInt(d.days || 0);
                const discount = parseFloat(d.discount || 0);
                const deposit = parseFloat(d.deposit || 0);

                const fullRent = pricePerDay * days;
                let rentAfterDiscount = fullRent - discount;
                if (rentAfterDiscount < 0) rentAfterDiscount = 0;
                const fee = rentAfterDiscount * 0.15;
                const ownerRevenue = (rentAfterDiscount - fee) + deposit;

                const fmt = (num) => '฿' + num.toLocaleString('th-TH', {minimumFractionDigits: 2, maximumFractionDigits: 2});

                if(document.getElementById('modal_total')) document.getElementById('modal_total').innerText = fmt(rentAfterDiscount);
                
                const discountRow = document.getElementById('row_discount');
                const discountVal = document.getElementById('modal_discount');
                if (discountRow && discountVal) {
                    if (discount > 0) {
                        discountRow.classList.remove('hidden');
                        discountVal.innerText = '-' + fmt(discount);
                    } else {
                        discountRow.classList.add('hidden');
                    }
                }

                if(document.getElementById('modal_fee')) document.getElementById('modal_fee').innerText = '-' + fmt(fee);
                if(document.getElementById('modal_deposit')) document.getElementById('modal_deposit').innerText = '+' + fmt(deposit);
                if(document.getElementById('modal_net')) document.getElementById('modal_net').innerText = fmt(ownerRevenue);

                // 5. จัดการปุ่มอนุมัติ
                const actionDiv = document.getElementById('modal_actions');
                if (d.status === 'pending') {
                    actionDiv.classList.remove('hidden');
                    document.getElementById('btn_approve').href = d.approveUrl;
                    document.getElementById('btn_reject').href = d.rejectUrl;
                } else {
                    actionDiv.classList.add('hidden');
                }

                // เปิด Modal
                const modal = document.getElementById('detailModal');
                const content = document.getElementById('detailModalContent');
                modal.classList.remove('hidden');
                setTimeout(() => {
                    content.classList.remove('scale-95');
                    content.classList.add('scale-100');
                }, 10);

            } catch (error) {
                console.error("Error opening modal:", error);
                alert("เกิดข้อผิดพลาดในการแสดงผลข้อมูล");
            }
        }

        function closeDetailModal() {
            const modal = document.getElementById('detailModal');
            const content = document.getElementById('detailModalContent');
            if (content) {
                content.classList.remove('scale-100');
                content.classList.add('scale-95');
            }
            setTimeout(() => {
                if (modal) modal.classList.add('hidden');
            }, 200);
        }

        window.onclick = function(event) {
            const modal = document.getElementById('detailModal');
            if (event.target == modal) {
                closeDetailModal();
            }
        }
    </script>
</body>
{% endblock %}