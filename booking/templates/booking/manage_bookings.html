{% extends 'basereview.html' %}
{% load static %}
{% load humanize %}

{% block content %}
<body class="bg-gray-100 font-sarabun">

    {% include 'car_rental/navbar_detail.html' %} <div class="container mx-auto flex flex-col md:flex-row p-4 md:p-8 gap-8 pt-24">
        {% include 'users/sidebar.html' %} 
        
        <main class="flex-1 p-4 md:p-8">
            
            <h1 class="text-3xl font-bold text-gray-800 mb-6">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h1>

            <div class="bg-white rounded-lg shadow-lg overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full text-left border-collapse">
                        <thead>
                            <tr class="bg-gray-50 text-gray-600 text-sm uppercase">
                                <th class="p-4 border-b">‡∏£‡∏ñ‡∏ó‡∏µ‡πà‡∏à‡∏≠‡∏á</th>
                                <th class="p-4 border-b">‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡πà‡∏≤</th>
                                <th class="p-4 border-b">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th> 
                                <th class="p-4 border-b">‡∏ß‡∏±‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</th>
                                <th class="p-4 border-b text-center">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                            </tr>
                        </thead>
                        <tbody class="text-gray-700">
                            {% for booking in bookings %}
                            <tr class="hover:bg-blue-50 transition border-b last:border-b-0">
                                
                                <td class="p-4 flex items-center gap-3">
                                    {% if booking.car.images.first %}
                                        <img src="{{ booking.car.images.first.image.url }}" class="w-12 h-12 rounded object-cover">
                                    {% endif %}
                                    <div>
                                        <div class="font-bold">{{ booking.car.brand }} {{ booking.car.model }}</div>
                                        <div class="text-xs text-gray-500">Ref: {{ booking.booking_ref }}</div>
                                    </div>
                                </td>

                                <td class="p-4">
                                    <button type="button" onclick="openDetailModal(this)" 
                                        class="group text-left focus:outline-none"
                                        
                                        data-status="{{ booking.status }}"
                                        data-id="{{ booking.id }}"
                                        data-ref="{{ booking.booking_ref }}" 
                                        data-name="{% if booking.user %}{{ booking.user.first_name }} {{ booking.user.last_name }}{% else %}{{ booking.guest.first_name }} {{ booking.guest.last_name }}{% endif %}"
                                        data-phone="{% if booking.user %}{{ booking.user.profile.phone|default:'-' }}{% else %}{{ booking.guest.phone_number }}{% endif %}"
                                        data-email="{% if booking.user %}{{ booking.user.email }}{% else %}{{ booking.guest.email }}{% endif %}"
                                        data-license="{% if booking.user %}{{ booking.user.profile.license_no|default:'-' }}{% else %}{{ booking.guest.license_number }}{% endif %}"
                                        data-profile-url="{% if booking.user %}{% url 'public_profile' booking.user.id %}{% endif %}"
                                        
                                        data-car="{{ booking.car.brand }} {{ booking.car.model }}"
                                        data-plate="{{ booking.car.license_plate }}"
                                        data-pickup="{{ booking.pickup_datetime|date:'d M Y, H:i' }}"
                                        data-dropoff="{{ booking.dropoff_datetime|date:'d M Y, H:i' }}"
                                        data-location="{{ booking.location }}"
                                        
                                        data-price-per-day="{{ booking.car.price_per_day }}"
                                        data-days="{{ booking.rental_days }}"
                                        data-discount="{{ booking.discount_amount }}"
                                        data-deposit="{{ booking.car.deposit|default:'0' }}"
                                        
                                        data-approve-url="{% url 'update_booking_status' booking.id 'approve' %}"
                                        data-reject-url="{% url 'update_booking_status' booking.id 'reject' %}"
                                    >
                                        <div class="font-semibold text-gray-800 group-hover:text-[#47B3C4] transition flex items-center gap-1">
                                            {% if booking.user %}
                                                <span class="hover:underline flex items-center gap-1 z-10 relative">
                                                    {{ booking.user.first_name }} {{ booking.user.last_name }}
                                                </span>
                                            {% else %}
                                                {{ booking.guest.first_name }} {{ booking.guest.last_name }}
                                            {% endif %}
                                            <i class="fas fa-search-plus text-xs opacity-0 group-hover:opacity-100 transition-opacity"></i>
                                        </div>
                                        <div class="text-[10px] text-[#47B3C4] mt-1 group-hover:underline">‡∏Ñ‡∏•‡∏¥‡∏Å‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</div>
                                    </button>
                                </td>

                                <td class="p-4">
                                    {% if booking.status == 'pending' %}
                                        <span class="bg-yellow-100 text-yellow-700 px-2 py-1 rounded text-xs font-bold">‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</span>
                                    {% elif booking.status == 'approved' %}
                                        <span class="bg-blue-100 text-blue-700 px-2 py-1 rounded text-xs font-bold">‡∏£‡∏≠‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</span>
                                    {% elif booking.status == 'waiting_verify' %}
                                        <span class="text-orange-600 bg-orange-100 px-2 py-1 rounded">
                                            <i class="fas fa-search-dollar"></i> ‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô
                                        </span>   
                                    {% elif booking.status == 'confirmed' %}
                                        <span class="bg-green-100 text-green-700 px-2 py-1 rounded text-xs font-bold">‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß</span>
                                    {% elif booking.status == 'picked_up' %}
                                        <span class="bg-purple-100 text-purple-700 px-2 py-1 rounded text-xs font-bold">‡∏£‡∏±‡∏ö‡∏£‡∏ñ‡πÅ‡∏•‡πâ‡∏ß</span>
                                    {% elif booking.status == 'completed' %}
                                        <span class="bg-gray-200 text-gray-600 px-2 py-1 rounded text-xs font-bold">‡∏à‡∏ö‡∏á‡∏≤‡∏ô</span>
                                    {% else %}
                                        <span class="bg-red-100 text-red-600 px-2 py-1 rounded text-xs font-bold">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å/‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò</span>
                                    {% endif %}
                                </td>

                                <td class="p-4 text-sm">
                                    <div><span class="text-gray-400">‡∏£‡∏±‡∏ö:</span> {{ booking.pickup_datetime|date:"d M H:i" }}</div>
                                    <div><span class="text-gray-400">‡∏Ñ‡∏∑‡∏ô:</span> {{ booking.dropoff_datetime|date:"d M H:i" }}</div>
                                </td>

                                <td class="p-4 text-center">
                                    {% if booking.status == 'confirmed' %}
                                        <a href="{% url 'inspection_page' booking.id %}" 
                                        class="inline-block bg-gray-600 hover:bg-gray-700 text-white px-3 py-1 rounded text-xs shadow transition">
                                            <i class="fas fa-camera mr-1"></i> ‡∏ï‡∏£‡∏ß‡∏à‡∏£‡∏ñ/‡∏™‡πà‡∏á‡∏°‡∏≠‡∏ö
                                        </a>
                                    {% elif booking.status == 'picked_up' %}
                                        <a href="{% url 'update_booking_status' booking.id 'completed' %}" 
                                        class="inline-block bg-gray-600 hover:bg-gray-700 text-white px-3 py-1 rounded text-xs shadow transition"
                                        onclick="return confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏±‡∏ö‡∏£‡∏ñ‡∏Ñ‡∏∑‡∏ô‡πÅ‡∏•‡∏∞‡∏à‡∏ö‡∏á‡∏≤‡∏ô?');">
                                            <i class="fas fa-flag-checkered mr-1"></i> ‡∏à‡∏ö‡∏á‡∏≤‡∏ô
                                        </a>
                                    {% elif booking.status == 'pending' %}
                                        <span class="text-xs text-yellow-600">‡∏Å‡∏î‡∏ó‡∏µ‡πà‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</span>
                                    {% elif booking.status == 'completed' %}
                                        {% if not booking.renter_review %}
                                            <button onclick="openReviewModal('{{ booking.id }}', '{{ booking.user.first_name }} {{ booking.user.last_name }}', 'renter')" 
                                                class="bg-blue-400 text-white px-3 py-1 rounded text-xs hover:bg-blue-500 ml-2 shadow transition">
                                                <i class="fas fa-user-check mr-1"></i> ‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤
                                            </button>
                                        {% else %}
                                            <div class="text-xs text-green-600 font-bold mt-1">
                                                <i class="fas fa-check-circle mr-1"></i> ‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß
                                                <span class="text-gray-400 font-normal">({{ booking.renter_review.rating }}/5)</span>
                                            </div>
                                        {% endif %}
                                    {% else %}
                                        <span class="text-xs text-gray-400">-</span>
                                    {% endif %}
                                </td>

                            </tr>
                            {% empty %}
                            <tr><td colspan="5" class="p-8 text-center text-gray-400">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <div id="detailModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4 backdrop-blur-sm transition-opacity">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl overflow-hidden transform scale-95 transition-transform duration-200" id="detailModalContent">
            
            <div class="bg-[#47B3C4] px-6 py-4 flex justify-between items-center text-white">
                <div>
                    <h3 class="text-lg font-bold">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÄ‡∏ä‡πà‡∏≤</h3>
                    <p class="text-sm opacity-90">Ref: <span id="modal_ref" class="font-mono font-bold"></span></p>
                </div>
                <button onclick="closeDetailModal()" class="text-white hover:text-gray-200 text-2xl font-bold">&times;</button>
            </div>

            <div class="p-6 overflow-y-auto max-h-[70vh]">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div class="bg-gray-50 p-4 rounded-lg border border-gray-100">
                        <div class="flex justify-between items-center border-b pb-2 mb-3">
                            <h4 class="text-gray-800 font-bold"><i class="fas fa-user mr-2 text-gray-400"></i>‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡πà‡∏≤</h4>
                            <a id="modal_profile_link" href="#" target="_blank" class="hidden text-xs bg-white border border-[#47B3C4] text-[#47B3C4] px-2 py-1 rounded hover:bg-[#47B3C4] hover:text-white transition shadow-sm">
                                <i class="fas fa-star mr-1"></i> ‡∏î‡∏π‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤
                            </a>
                        </div>
                        <p class="text-sm">‡∏ä‡∏∑‡πà‡∏≠: <span id="modal_name" class="font-medium"></span></p>
                        <p class="text-sm mt-1">‡πÄ‡∏ö‡∏≠‡∏£‡πå: <span id="modal_phone" class="font-medium"></span></p>
                        <p class="text-sm mt-1">Email: <span id="modal_email" class="font-medium"></span></p>
                        <p class="text-sm mt-1">‡πÉ‡∏ö‡∏Ç‡∏±‡∏ö‡∏Ç‡∏µ‡πà: <span id="modal_license" class="font-medium"></span></p>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-lg border border-gray-100">
                        <h4 class="text-gray-800 font-bold mb-3 border-b pb-1"><i class="fas fa-car mr-2 text-gray-400"></i>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πà‡∏≤</h4>
                        <p class="text-sm">‡∏£‡∏ñ: <span id="modal_car" class="font-medium"></span></p>
                        <p class="text-xs text-gray-400 mb-2">(<span id="modal_plate"></span>)</p>
                        <p class="text-xs">‡∏£‡∏±‡∏ö: <span id="modal_pickup" class="font-medium"></span></p>
                        <p class="text-xs">‡∏Ñ‡∏∑‡∏ô: <span id="modal_dropoff" class="font-medium"></span></p>
                        <p class="text-xs mt-1">‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà: <span id="modal_location" class="font-medium"></span></p>
                    </div>
                </div>

                <div class="bg-white border-2 border-dashed border-[#47B3C4] rounded-lg p-4 mb-6">
                    <h4 class="text-center text-gray-600 font-bold mb-4">‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ</h4>
                    
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-gray-600">‡∏¢‡∏≠‡∏î‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤ (‡∏´‡∏•‡∏±‡∏á‡∏´‡∏±‡∏Å‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î)</span>
                        <span class="font-bold text-lg" id="modal_total"></span>
                    </div>
                    
                    <div class="flex justify-between items-center mb-2 text-yellow-600 text-sm bg-yellow-50 p-1 rounded">
                        <span><i class="fas fa-hand-holding-usd mr-1"></i> ‡∏£‡∏±‡∏ö‡∏°‡∏±‡∏î‡∏à‡∏≥‡πÄ‡∏û‡∏¥‡πà‡∏° (‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î)</span>
                        <span class="font-bold" id="modal_deposit"></span>
                    </div>
                    
                    <div id="row_discount" class="flex justify-between items-center mb-2 text-green-600 text-sm hidden">
                        <span><i class="fas fa-tag mr-1"></i> ‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô</span>
                        <span id="modal_discount"></span>
                    </div>

                    <div class="flex justify-between items-center mb-2 text-red-500 text-sm">
                        <span>‡∏´‡∏±‡∏Å‡∏Ñ‡πà‡∏≤‡∏ò‡∏£‡∏£‡∏°‡πÄ‡∏ô‡∏µ‡∏¢‡∏°‡∏£‡∏∞‡∏ö‡∏ö (15% ‡∏Ç‡∏≠‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤)</span>
                        <span id="modal_fee"></span>
                    </div>
                    
                    <div class="border-t pt-2 flex justify-between items-center mt-2">
                        <span class="font-bold text-gray-800">‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏™‡∏∏‡∏ó‡∏ò‡∏¥‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö</span>
                        <span class="text-2xl font-bold text-green-600" id="modal_net"></span>
                    </div>
                </div>
            </div>

            <div class="bg-gray-50 px-6 py-4 flex justify-end gap-3 border-t">
                <button onclick="closeDetailModal()" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-lg font-medium transition">
                    ‡∏õ‡∏¥‡∏î
                </button>
                
                <div id="modal_actions" class="flex gap-3 hidden">
                    <a id="btn_reject" href="#" onclick="return confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò?');" class="px-4 py-2 border border-red-500 text-red-500 hover:bg-red-50 rounded-lg font-bold transition flex items-center">
                        <i class="fas fa-times mr-2"></i> ‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò
                    </a>
                    <a id="btn_approve" href="#" class="px-6 py-2 bg-[#47B3C4] hover:bg-[#3a9faa] text-white rounded-lg font-bold shadow-lg transition flex items-center">
                        <i class="fas fa-check mr-2"></i> ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥
                    </a>
                </div>
            </div>
        </div>
    </div>

    <script>
        function openDetailModal(btn) {
            try {
                const d = btn.dataset;

                // 1. ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô
                document.getElementById('modal_ref').innerText = '#' + (d.ref || '-');
                document.getElementById('modal_name').innerText = d.name || '-';
                document.getElementById('modal_phone').innerText = d.phone || '-';
                document.getElementById('modal_email').innerText = d.email || '-';
                document.getElementById('modal_license').innerText = d.license || '-';

                const profileLink = document.getElementById('modal_profile_link');
                if (profileLink) {
                    if (d.profileUrl && d.profileUrl.trim() !== "") {
                        profileLink.href = d.profileUrl;
                        profileLink.classList.remove('hidden');
                        profileLink.style.display = 'inline-flex';
                    } else {
                        profileLink.classList.add('hidden');
                    }
                }

                // 2. ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏ñ
                document.getElementById('modal_car').innerText = d.car || '-';
                document.getElementById('modal_plate').innerText = d.plate || '-';
                document.getElementById('modal_pickup').innerText = d.pickup || '-';
                document.getElementById('modal_dropoff').innerText = d.dropoff || '-';
                document.getElementById('modal_location').innerText = d.location || '-'; 

                // =========================================================
                // üí∞ 3. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏á‡∏¥‡∏ô (Logic ‡πÉ‡∏´‡∏°‡πà: ‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô - ‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î -> ‡∏Ñ‡∏¥‡∏î Fee)
                // =========================================================
                
                // ‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å‡∏õ‡∏∏‡πà‡∏°
                const pricePerDay = parseFloat(d.pricePerDay || 0);
                const days = parseInt(d.days || 0);
                const discount = parseFloat(d.discount || 0);
                const deposit = parseFloat(d.deposit || 0);

                // 1. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤‡∏£‡∏ß‡∏° (Gross Rent) = ‡∏£‡∏≤‡∏Ñ‡∏≤/‡∏ß‡∏±‡∏ô * ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏±‡∏ô
                const fullRent = pricePerDay * days;

                // 2. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤‡∏´‡∏•‡∏±‡∏á‡∏´‡∏±‡∏Å‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î (Net Rent)
                // ‡∏¢‡∏≠‡∏î‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∑‡∏≠‡∏¢‡∏≠‡∏î‡∏ó‡∏µ‡πà‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏à‡πà‡∏≤‡∏¢‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤ (‡πÑ‡∏°‡πà‡∏£‡∏ß‡∏°‡∏°‡∏±‡∏î‡∏à‡∏≥)
                let rentAfterDiscount = fullRent - discount;
                if (rentAfterDiscount < 0) rentAfterDiscount = 0;

                // 3. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏°‡∏°‡∏¥‡∏ä‡∏ä‡∏±‡πà‡∏ô 15% (‡∏Ñ‡∏¥‡∏î‡∏à‡∏≤‡∏Å‡∏¢‡∏≠‡∏î‡πÄ‡∏ä‡πà‡∏≤‡∏´‡∏•‡∏±‡∏á‡∏•‡∏î)
                const fee = rentAfterDiscount * 0.15;

                // 4. ‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏™‡∏∏‡∏ó‡∏ò‡∏¥‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á (Owner Revenue)
                // ‡∏™‡∏π‡∏ï‡∏£: (‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏à‡∏≤‡∏Å‡∏´‡∏±‡∏Å‡∏Ñ‡∏≠‡∏°‡∏Ø) + ‡∏°‡∏±‡∏î‡∏à‡∏≥‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡∏°‡∏≤
                const ownerRevenue = (rentAfterDiscount - fee) + deposit;


                // --- 4. ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç ---
                const fmt = (num) => '‡∏ø' + num.toLocaleString('th-TH', {minimumFractionDigits: 2, maximumFractionDigits: 2});

                // ‡πÅ‡∏™‡∏î‡∏á‡∏¢‡∏≠‡∏î‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤ (‡∏´‡∏•‡∏±‡∏á‡∏´‡∏±‡∏Å‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î) ‡∏ó‡∏µ‡πà‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏à‡πà‡∏≤‡∏¢
                if(document.getElementById('modal_total')) document.getElementById('modal_total').innerText = fmt(rentAfterDiscount);
                
                // ‡πÅ‡∏™‡∏î‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
                const discountRow = document.getElementById('row_discount');
                const discountVal = document.getElementById('modal_discount');
                if (discountRow && discountVal) {
                    if (discount > 0) {
                        discountRow.classList.remove('hidden');
                        discountVal.innerText = '-' + fmt(discount);
                    } else {
                        discountRow.classList.add('hidden');
                    }
                }

                // ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏°‡∏°‡∏¥‡∏ä‡∏ä‡∏±‡πà‡∏ô
                if(document.getElementById('modal_fee')) document.getElementById('modal_fee').innerText = '-' + fmt(fee);
                
                // ‡πÅ‡∏™‡∏î‡∏á‡∏¢‡∏≠‡∏î‡∏°‡∏±‡∏î‡∏à‡∏≥
                if(document.getElementById('modal_deposit')) document.getElementById('modal_deposit').innerText = '+' + fmt(deposit);
                
                // ‡πÅ‡∏™‡∏î‡∏á‡∏¢‡∏≠‡∏î‡∏™‡∏∏‡∏ó‡∏ò‡∏¥‡∏ó‡∏µ‡πà‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö
                if(document.getElementById('modal_net')) document.getElementById('modal_net').innerText = fmt(ownerRevenue);


                // --- 5. ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏õ‡∏∏‡πà‡∏°‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ (‡πÇ‡∏ä‡∏ß‡πå‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ pending) ---
                const actionDiv = document.getElementById('modal_actions');
                if (d.status === 'pending') {
                    actionDiv.classList.remove('hidden');
                    document.getElementById('btn_approve').href = d.approveUrl;
                    document.getElementById('btn_reject').href = d.rejectUrl;
                } else {
                    actionDiv.classList.add('hidden');
                }

                // ‡πÄ‡∏õ‡∏¥‡∏î Modal
                const modal = document.getElementById('detailModal');
                const content = document.getElementById('detailModalContent');
                modal.classList.remove('hidden');
                setTimeout(() => {
                    content.classList.remove('scale-95');
                    content.classList.add('scale-100');
                }, 10);

            } catch (error) {
                console.error("Error opening modal:", error);
                alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•");
            }
        }

        function closeDetailModal() {
            const modal = document.getElementById('detailModal');
            const content = document.getElementById('detailModalContent');
            if (content) {
                content.classList.remove('scale-100');
                content.classList.add('scale-95');
            }
            setTimeout(() => {
                if (modal) modal.classList.add('hidden');
            }, 200);
        }

        window.onclick = function(event) {
            const modal = document.getElementById('detailModal');
            if (event.target == modal) {
                closeDetailModal();
            }
        }
    </script>
</body>
{% endblock %}