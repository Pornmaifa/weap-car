{% extends 'basereview.html' %}
{% load static %}
{% load humanize %}
{% load i18n %} {% block content %}
    {% trans "‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏ô‡∏µ‡πâ?" as msg_confirm_reject_1 %}
    {% trans "‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò?" as msg_confirm_reject_2 %}
    
    {% include 'car_rental/navbar_detail.html' %}

    <div class="container mx-auto flex flex-col md:flex-row p-4 md:p-8 gap-8 pt-24">
        
        {% include 'users/sidebar.html' %} 
        
        <main class="flex-1 p-4 md:p-8">
            <h1 class="text-3xl font-bold text-gray-800 mb-6">{% trans "‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÄ‡∏ä‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥" %}</h1>

            <div class="bg-white rounded-lg shadow-lg overflow-hidden">
                {% if pending_bookings %}
                    <div class="overflow-x-auto">
                        <table class="w-full text-left border-collapse">
                            <thead>
                                <tr class="bg-gray-50 text-gray-600 text-sm uppercase">
                                    <th class="p-4 border-b">{% trans "‡∏£‡∏ñ‡∏ó‡∏µ‡πà‡∏à‡∏≠‡∏á" %}</th>
                                    <th class="p-4 border-b">{% trans "‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡πà‡∏≤" %}</th>
                                    <th class="p-4 border-b">{% trans "‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô" %}</th>
                                    <th class="p-4 border-b">{% trans "‡∏£‡∏ß‡∏°‡πÄ‡∏á‡∏¥‡∏ô" %}</th>
                                    <th class="p-4 border-b text-center">{% trans "‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£" %}</th>
                                </tr>
                            </thead>
                            <tbody class="text-gray-700">
                                {% for booking in pending_bookings %}
                                <tr class="hover:bg-blue-50 transition border-b last:border-b-0">
                                    <td class="p-4 flex items-center gap-3">
                                        {% if booking.car.images.first %}
                                            <img src="{{ booking.car.images.first.image.url }}" class="w-12 h-12 rounded object-cover">
                                        {% endif %}
                                        <div>
                                            <div class="font-bold">{{ booking.car.brand }} {{ booking.car.model }}</div>
                                            <div class="text-xs text-gray-500">{{ booking.car.license_plate }}</div>
                                        </div>
                                    </td>
                                    
                                    <td class="p-4">
                                        <button type="button" onclick="openDetailModal(this)" 
                                            class="group text-left focus:outline-none"
                                            
                                            data-id="{{ booking.id }}"
                                            data-ref="{{ booking.booking_ref }}" 
                                            
                                            data-name="{% if booking.user %}{{ booking.user.first_name }} {{ booking.user.last_name }}{% else %}{{ booking.guest.first_name }} {{ booking.guest.last_name }}{% endif %}"
                                            data-phone="{% if booking.user %}{{ booking.user.profile.phone|default:'-' }}{% else %}{{ booking.guest.phone_number }}{% endif %}"
                                            data-email="{% if booking.user %}{{ booking.user.email }}{% else %}{{ booking.guest.email }}{% endif %}"
                                            data-license="{% if booking.user %}{{ booking.user.profile.license_number|default:'-' }}{% else %}{{ booking.guest.license_number }}{% endif %}"
                                            
                                            data-profile-url="{% if booking.user %}{% url 'public_profile' booking.user.id %}{% endif %}"
                                            data-price-per-day="{{ booking.car.price_per_day }}"
                                            data-days="{{ booking.rental_days }}"
                                            data-car="{{ booking.car.brand }} {{ booking.car.model }}"
                                            data-plate="{{ booking.car.license_plate }}"
                                            data-pickup="{{ booking.pickup_datetime|date:'d M Y, H:i' }}"
                                            data-dropoff="{{ booking.dropoff_datetime|date:'d M Y, H:i' }}"
                                            data-location="{{ booking.location }}"
                                            data-total="{{ booking.total_price|add:booking.discount_amount }}"
                                            data-discount="{{ booking.discount_amount }}"
                                            data-deposit="{{ booking.car.deposit|default:'0' }}"

                                            data-approve-url="{% url 'update_booking_status' booking.id 'approve' %}"
                                            data-reject-url="{% url 'update_booking_status' booking.id 'reject' %}"
                                        >
                                            <div class="font-semibold text-gray-800 group-hover:text-[#47B3C4] transition flex items-center gap-1">
                                                {% if booking.user %}
                                                    {{ booking.user.first_name }} {{ booking.user.last_name }}
                                                {% else %}
                                                    {{ booking.guest.first_name }} {{ booking.guest.last_name }}
                                                {% endif %}
                                                <i class="fas fa-search-plus text-xs opacity-0 group-hover:opacity-100 transition-opacity"></i>
                                            </div>
                                            <div class="text-[10px] text-[#47B3C4] mt-1 group-hover:underline">
                                                {% trans "‡∏Ñ‡∏•‡∏¥‡∏Å‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î" %}
                                            </div>
                                        </button>
                                    </td>

                                    <td class="p-4 text-sm">
                                        <div>{% trans "‡∏£‡∏±‡∏ö:" %} {{ booking.pickup_datetime|date:"d M H:i" }}</div>
                                        <div>{% trans "‡∏Ñ‡∏∑‡∏ô:" %} {{ booking.dropoff_datetime|date:"d M H:i" }}</div>
                                    </td>
                                    
                                    <td class="p-4 font-bold text-[#47B3C4]">
                                        ‡∏ø{{ booking.total_price|intcomma }}
                                    </td>
                                    
                                    <td class="p-4 text-center space-x-2">
                                        <a href="{% url 'update_booking_status' booking.id 'approve' %}" 
                                           class="inline-block bg-green-500 text-white px-3 py-1 rounded text-sm hover:bg-green-600 transition shadow-sm">
                                            {% trans "‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥" %}
                                        </a>
                                        <a href="{% url 'update_booking_status' booking.id 'reject' %}" 
                                           class="inline-block bg-red-100 text-red-600 px-3 py-1 rounded text-sm hover:bg-red-200 transition"
                                           onclick="return confirm('{{ msg_reject_confirm|escapejs }}');">
                                            {% trans "‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò" %}
                                        </a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="p-12 text-center text-gray-400">
                        <i class="fas fa-clipboard-check text-6xl mb-4 text-gray-200"></i>
                        <p>{% trans "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÄ‡∏ä‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÉ‡∏ô‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ" %}</p>
                    </div>
                {% endif %}
            </div>
        </main>
    </div>

    <div id="detailModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4 backdrop-blur-sm transition-opacity">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl overflow-hidden transform scale-95 transition-transform duration-200" id="detailModalContent">
            
            <div class="bg-[#47B3C4] px-6 py-4 flex justify-between items-center text-white">
                <div>
                    <h3 class="text-lg font-bold">{% trans "‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÄ‡∏ä‡πà‡∏≤" %}</h3>
                    <p class="text-sm opacity-90">Ref Code: <span id="modal_ref" class="font-mono font-bold bg-white/20 px-2 py-0.5 rounded"></span></p>
                </div>
                <button onclick="closeDetailModal()" class="text-white hover:text-gray-200 text-2xl font-bold">&times;</button>
            </div>

            <div class="p-6 overflow-y-auto max-h-[70vh]">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    
                    <div class="bg-gray-50 p-4 rounded-lg border border-gray-100">
                        <div class="flex justify-between items-center border-b pb-2 mb-3">
                            <h4 class="text-gray-800 font-bold"><i class="fas fa-user mr-2 text-gray-400"></i>{% trans "‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡πà‡∏≤" %}</h4>
                            
                            <a id="modal_profile_link" href="#" target="_blank" class="hidden text-xs bg-white border border-[#47B3C4] text-[#47B3C4] px-2 py-1 rounded hover:bg-[#47B3C4] hover:text-white transition shadow-sm">
                                <i class="fas fa-star mr-1"></i> {% trans "‡∏î‡∏π‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤" %}
                            </a>
                        </div>

                        <p class="text-sm text-gray-500">{% trans "‡∏ä‡∏∑‡πà‡∏≠:" %} <span id="modal_name" class="font-medium text-gray-800 text-base"></span></p>
                        <p class="text-sm text-gray-500 mt-1">{% trans "‡πÄ‡∏ö‡∏≠‡∏£‡πå:" %} <span id="modal_phone" class="font-medium text-gray-800"></span></p>
                        <p class="text-sm text-gray-500 mt-1">Email: <span id="modal_email" class="font-medium text-gray-800"></span></p>
                        <p class="text-sm text-gray-500 mt-1">{% trans "‡πÉ‡∏ö‡∏Ç‡∏±‡∏ö‡∏Ç‡∏µ‡πà:" %} <span id="modal_license" class="font-medium text-gray-800"></span></p>
                    </div>

                    <div class="bg-gray-50 p-4 rounded-lg border border-gray-100">
                        <h4 class="text-gray-800 font-bold mb-3 border-b pb-1"><i class="fas fa-car mr-2 text-gray-400"></i>{% trans "‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πà‡∏≤" %}</h4>
                        <p class="text-sm text-gray-500">{% trans "‡∏£‡∏ñ:" %} <span id="modal_car" class="font-medium text-gray-800"></span></p>
                        <p class="text-xs text-gray-400 mb-2">(<span id="modal_plate"></span>)</p>
                        
                        <p class="text-xs text-gray-500">{% trans "‡∏£‡∏±‡∏ö:" %} <span id="modal_pickup" class="font-medium text-gray-800"></span></p>
                        <p class="text-xs text-gray-500">{% trans "‡∏Ñ‡∏∑‡∏ô:" %} <span id="modal_dropoff" class="font-medium text-gray-800"></span></p>
                        <p class="text-xs text-gray-500 mt-1">{% trans "‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà:" %} <span id="modal_location" class="font-medium text-gray-800"></span></p>
                    </div>
                </div>

                <div class="bg-white border-2 border-dashed border-[#47B3C4] rounded-lg p-4 mb-6">
                    <h4 class="text-center text-gray-600 font-bold mb-4">{% trans "‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ" %}</h4>
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-gray-600">{% trans "‡∏¢‡∏≠‡∏î‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤‡∏´‡∏•‡∏±‡∏á‡∏´‡∏±‡∏Å‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î" %}</span>
                        <span class="font-bold text-lg" id="modal_total"></span>
                    </div>
                    <div class="flex justify-between items-center mb-2 text-yellow-600 text-sm bg-yellow-50 p-1 rounded">
                        <span><i class="fas fa-hand-holding-usd mr-1"></i> {% trans "‡∏£‡∏±‡∏ö‡∏°‡∏±‡∏î‡∏à‡∏≥‡πÄ‡∏û‡∏¥‡πà‡∏° (‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î)" %}</span>
                        <span class="font-bold" id="modal_deposit"></span>
                    </div>
                    
                    <div id="row_discount" class="flex justify-between items-center mb-2 text-green-600 text-sm hidden">
                        <span><i class="fas fa-tag mr-1"></i> {% trans "‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô" %}</span>
                        <span id="modal_discount"></span>
                    </div>

                    <div class="flex justify-between items-center mb-2 text-red-500 text-sm">
                        <span>{% trans "‡∏´‡∏±‡∏Å‡∏Ñ‡πà‡∏≤‡∏ò‡∏£‡∏£‡∏°‡πÄ‡∏ô‡∏µ‡∏¢‡∏°‡∏£‡∏∞‡∏ö‡∏ö (15%)" %}</span>
                        <span id="modal_fee"></span>
                    </div>
                    <div class="border-t pt-2 flex justify-between items-center mt-2">
                        <span class="font-bold text-gray-800">{% trans "‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏™‡∏∏‡∏ó‡∏ò‡∏¥‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö" %}</span>
                        <span class="text-2xl font-bold text-green-600" id="modal_net"></span>
                    </div>
                </div>
            </div>

            <div class="bg-gray-50 px-6 py-4 flex justify-end gap-3 border-t">
                <button onclick="closeDetailModal()" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-lg font-medium transition">
                    {% trans "‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á" %}
                </button>
                
                <a id="btn_reject" href="#" onclick="return confirm('{{ msg_confirm_reject_2|escapejs }}');"
                   class="px-4 py-2 border border-red-500 text-red-500 hover:bg-red-50 rounded-lg font-bold transition flex items-center">
                   <i class="fas fa-times mr-2"></i> {% trans "‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò" %}
                </a>

                <a id="btn_approve" href="#" 
                   class="px-6 py-2 bg-[#47B3C4] hover:bg-[#3a9faa] text-white rounded-lg font-bold shadow-lg transition transform hover:-translate-y-0.5 flex items-center">
                   <i class="fas fa-check mr-2"></i> {% trans "‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á" %}
                </a>
            </div>
        </div>
    </div>

<script>
    function openDetailModal(btn) {
        try {
            const d = btn.dataset;

            // --- 1. ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°) ---
            if(document.getElementById('modal_ref')) document.getElementById('modal_ref').innerText = '#' + (d.ref || '-');
            if(document.getElementById('modal_name')) document.getElementById('modal_name').innerText = d.name || '-';
            if(document.getElementById('modal_phone')) document.getElementById('modal_phone').innerText = d.phone || '-';
            if(document.getElementById('modal_email')) document.getElementById('modal_email').innerText = d.email || '-';
            if(document.getElementById('modal_license')) document.getElementById('modal_license').innerText = d.license || '-';

            const profileLink = document.getElementById('modal_profile_link');
            if (profileLink) {
                if (d.profileUrl && d.profileUrl.trim() !== "") {
                    profileLink.href = d.profileUrl;
                    profileLink.classList.remove('hidden');
                    profileLink.style.display = 'inline-flex';
                } else {
                    profileLink.classList.add('hidden');
                }
            }

            // --- 2. ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏ñ (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°) ---
            if(document.getElementById('modal_car')) document.getElementById('modal_car').innerText = d.car || '-';
            if(document.getElementById('modal_plate')) document.getElementById('modal_plate').innerText = d.plate || '-';
            if(document.getElementById('modal_pickup')) document.getElementById('modal_pickup').innerText = d.pickup || '-';
            if(document.getElementById('modal_dropoff')) document.getElementById('modal_dropoff').innerText = d.dropoff || '-';
            if (document.getElementById('modal_location')) {
                document.getElementById('modal_location').innerText = d.location || '-'; 
            }

            // =========================================================
            // üí∞ 3. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏á‡∏¥‡∏ô (Logic ‡πÉ‡∏´‡∏°‡πà: ‡∏Ñ‡∏¥‡∏î‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô)
            // =========================================================
            
            // ‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡∏°‡∏≤‡∏à‡∏≤‡∏Å‡∏õ‡∏∏‡πà‡∏°
            const pricePerDay = parseFloat(d.pricePerDay || 0);
            const days = parseInt(d.days || 0);
            const discount = parseFloat(d.discount || 0);
            const deposit = parseFloat(d.deposit || 0);

            // 1. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤‡∏£‡∏ß‡∏° (Gross Rent)
            const fullRent = pricePerDay * days;

            // 2. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤‡∏´‡∏•‡∏±‡∏á‡∏´‡∏±‡∏Å‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î (Net Rent)
            // ‡∏¢‡∏≠‡∏î‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏ô‡∏≥‡πÑ‡∏õ‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏µ‡πà‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î "‡∏¢‡∏≠‡∏î‡∏ä‡∏≥‡∏£‡∏∞‡∏à‡∏≤‡∏Å‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤"
            let rentAfterDiscount = fullRent - discount;
            if (rentAfterDiscount < 0) rentAfterDiscount = 0;

            // 3. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏°‡∏°‡∏¥‡∏ä‡∏ä‡∏±‡πà‡∏ô 15% (‡∏Ñ‡∏¥‡∏î‡∏à‡∏≤‡∏Å‡∏¢‡∏≠‡∏î‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤‡∏´‡∏•‡∏±‡∏á‡∏´‡∏±‡∏Å‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î)
            const fee = rentAfterDiscount * 0.15;

            // 4. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏™‡∏∏‡∏ó‡∏ò‡∏¥‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á (Owner Revenue)
            // ‡∏™‡∏π‡∏ï‡∏£: (‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤‡∏´‡∏•‡∏±‡∏á‡∏•‡∏î - ‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏°‡∏Ø) + ‡∏°‡∏±‡∏î‡∏à‡∏≥
            const ownerRevenue = (rentAfterDiscount - fee) + deposit;


            // --- 4. ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç ---
            const fmt = (num) => '‡∏ø' + num.toLocaleString('th-TH', {minimumFractionDigits: 2, maximumFractionDigits: 2});

            // ‡πÅ‡∏™‡∏î‡∏á‡∏¢‡∏≠‡∏î‡πÄ‡∏ä‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏à‡πà‡∏≤‡∏¢ (‡∏´‡∏•‡∏±‡∏á‡∏´‡∏±‡∏Å‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡πÅ‡∏•‡πâ‡∏ß)
            if(document.getElementById('modal_total')) document.getElementById('modal_total').innerText = fmt(rentAfterDiscount);
            
            // ‡πÅ‡∏™‡∏î‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
            const discountRow = document.getElementById('row_discount');
            const discountVal = document.getElementById('modal_discount');
            if (discountRow && discountVal) {
                if (discount > 0) {
                    discountRow.classList.remove('hidden');
                    discountVal.innerText = '-' + fmt(discount);
                } else {
                    discountRow.classList.add('hidden');
                }
            }

            // ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏°‡∏°‡∏¥‡∏ä‡∏ä‡∏±‡πà‡∏ô
            if(document.getElementById('modal_fee')) document.getElementById('modal_fee').innerText = '-' + fmt(fee);
            
            // ‡πÅ‡∏™‡∏î‡∏á‡∏¢‡∏≠‡∏î‡∏°‡∏±‡∏î‡∏à‡∏≥
            if(document.getElementById('modal_deposit')) document.getElementById('modal_deposit').innerText = '+' + fmt(deposit);
            
            // ‡πÅ‡∏™‡∏î‡∏á‡∏¢‡∏≠‡∏î‡∏™‡∏∏‡∏ó‡∏ò‡∏¥‡∏ó‡∏µ‡πà‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö
            if(document.getElementById('modal_net')) document.getElementById('modal_net').innerText = fmt(ownerRevenue);


            // --- 5. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏õ‡∏∏‡πà‡∏° ---
            if(document.getElementById('btn_approve')) document.getElementById('btn_approve').href = d.approveUrl;
            if(document.getElementById('btn_reject')) document.getElementById('btn_reject').href = d.rejectUrl;

            // ‡πÄ‡∏õ‡∏¥‡∏î Modal
            const modal = document.getElementById('detailModal');
            const content = document.getElementById('detailModalContent');
            if(modal && content) {
                modal.classList.remove('hidden');
                setTimeout(() => {
                    content.classList.remove('scale-95');
                    content.classList.add('scale-100');
                }, 10);
            }

        } catch (error) {
            console.error("Error opening modal:", error);
            alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•");
        }
    }

    function closeDetailModal() {
        const modal = document.getElementById('detailModal');
        const content = document.getElementById('detailModalContent');
        if (content) {
            content.classList.remove('scale-100');
            content.classList.add('scale-95');
        }
        setTimeout(() => {
            if (modal) modal.classList.add('hidden');
        }, 200);
    }

    window.onclick = function(event) {
        const modal = document.getElementById('detailModal');
        if (event.target == modal) {
            closeDetailModal();
        }
    }
</script>
{% endblock %}