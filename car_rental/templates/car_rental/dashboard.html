{% load static %}
{% load humanize %}
{% load i18n %} <!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% trans "Owner Dashboard - WarpCar" %}</title> <link href="{% static 'dist/styles.css' %}?v=4" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body class="bg-gray-100 font-sarabun">

    {% include 'car_rental/navbar_detail.html' %}

    <div class="container mx-auto flex flex-col md:flex-row p-4 md:p-8 gap-8">
         {% include 'users/sidebar.html' %}
            
        <main class="flex-1 p-4 md:p-8 fade-in">
            
            <div class="flex flex-col md:flex-row md:items-center justify-between mb-6 gap-4">
                <div>
                    <h1 class="text-3xl font-bold text-gray-800">{% trans "Owner Dashboard" %}</h1>
                    <p class="text-gray-500 mt-1">{% trans "‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏õ‡∏µ" %} 
                        <span class="text-[#47B3C4] font-bold text-lg">{{ thai_year_display }}</span>
                    </p>
                </div>

                <div class="flex items-center gap-3">
                    <form method="GET" action="{% url 'dashboard' %}" class="flex items-center bg-white px-3 py-2 rounded-lg shadow-sm border border-gray-200">
                        <label class="text-sm text-gray-500 mr-2"><i class="far fa-calendar-alt"></i> {% trans "‡∏õ‡∏µ ‡∏û.‡∏®.:" %}</label>
                        <select name="year" onchange="this.form.submit()" class="bg-transparent font-bold text-gray-700 outline-none cursor-pointer">
                            {% for y in available_years %}
                                <option value="{{ y }}" {% if y == selected_year %}selected{% endif %}>
                                    {{ y|add:543 }}
                                </option>
                            {% endfor %}
                        </select>
                    </form>

                    <a href="{% url 'add_car' %}" class="bg-[#47B3C4] hover:bg-[#3a9faa] text-white px-4 py-2 rounded shadow flex items-center gap-2 font-medium transition transform hover:scale-105">
                        <i class="fas fa-plus"></i> {% trans "‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏ñ‡πÉ‡∏´‡∏°‡πà" %}
                    </a>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                <div onclick="showSection('cars', this)" id="card-cars" class="bg-white p-6 rounded-lg shadow cursor-pointer border-b-4 border-[#47B3C4] ring-2 ring-[#47B3C4] ring-opacity-40 transition hover:shadow-lg">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-sm text-gray-500 font-semibold mb-1">{% trans "‡∏£‡∏ñ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î" %}</p>
                            <p class="text-3xl font-bold text-gray-800">{{ total_cars|intcomma }}</p>
                        </div>
                        <div class="p-3 bg-blue-50 rounded-full text-[#47B3C4]"><i class="fas fa-car text-xl"></i></div>
                    </div>
                </div>
                <div onclick="showSection('bookings', this)" id="card-bookings" class="bg-white p-6 rounded-lg shadow cursor-pointer border-b-4 border-transparent hover:border-[#EAB308] transition hover:shadow-lg">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-sm text-gray-500 font-semibold mb-1">{% trans "‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î" %}</p>
                            <p class="text-3xl font-bold text-gray-800">{{ total_bookings|intcomma }}</p>
                            <p class="text-xs text-gray-400 mt-1 font-medium">
                                <i class="far fa-clock mr-1"></i> {% blocktrans with days=total_days_booked|intcomma %}‡∏£‡∏ß‡∏° {{ days }} ‡∏ß‡∏±‡∏ô{% endblocktrans %}
                            </p>
                        </div>
                        <div class="p-3 bg-yellow-50 rounded-full text-yellow-600"><i class="fas fa-bookmark text-xl"></i></div>
                    </div>
                </div>
                <div onclick="showSection('revenue', this)" id="card-revenue" class="bg-white p-6 rounded-lg shadow cursor-pointer border-b-4 border-transparent hover:border-[#22c55e] transition hover:shadow-lg">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-sm text-gray-500 font-semibold mb-1">{% trans "‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏£‡∏ß‡∏°" %}</p>
                            <p class="text-3xl font-bold text-green-600">‡∏ø{{ total_revenue|intcomma }}</p>
                        </div>
                        <div class="p-3 bg-green-50 rounded-full text-green-600"><i class="fas fa-wallet text-xl"></i></div>
                    </div>
                </div>
                <div onclick="showSection('insights', this)" id="card-insights" class="bg-white p-6 rounded-lg shadow cursor-pointer border-b-4 border-transparent hover:border-[#ef4444] transition hover:shadow-lg relative overflow-hidden">
                    <div class="flex justify-between items-start z-10 relative">
                        <div>
                            <p class="text-sm text-gray-500 font-semibold mb-1">{% trans "‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥" %}</p>
                            <p class="text-lg font-bold text-gray-800">{% blocktrans with count=recommendations|length %}{{ count }} ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°{% endblocktrans %}</p>
                        </div>
                        <div class="p-3 bg-red-50 rounded-full text-red-500"><i class="fas fa-lightbulb text-xl"></i></div>
                    </div>
                    {% if recommendations %}
                        <div class="absolute top-2 right-2 w-2 h-2 bg-red-500 rounded-full animate-ping"></div>
                    {% endif %}
                </div>
            </div>

            <div class="bg-white rounded-lg shadow-lg p-6 min-h-[500px] transition-all">

                <div id="section-cars" class="tab-content fade-in">
                    <div class="flex justify-between items-center mb-6 border-l-4 border-[#47B3C4] pl-4">
                        <h2 class="text-xl font-bold text-gray-800">{% trans "‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏ñ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì" %}</h2>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left border-collapse">
                            <thead class="bg-gray-50 text-gray-600 uppercase border-b">
                                <tr>
                                    <th class="p-4 rounded-tl-lg">{% trans "‡∏£‡∏π‡∏õ‡∏£‡∏ñ" %}</th>
                                    <th class="p-4">{% trans "‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î" %}</th>
                                    <th class="p-4">{% trans "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞" %}</th>
                                    <th class="p-4">{% trans "‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥" %}</th>
                                    <th class="p-4 text-right rounded-tr-lg">{% trans "‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£" %}</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y">
                                {% for car in cars %}
                                <tr class="hover:bg-gray-50 transition duration-150">
                                    
                                    <td class="p-4 w-32 align-top">
                                        <a href="{% url 'car_detail' car.id %}" target="_blank" class="block relative group">
                                            {% if car.images.all %}
                                                <img src="{{ car.images.first.image.url }}" class="h-20 w-32 object-cover rounded-lg shadow-sm border border-gray-200 group-hover:opacity-90 transition">
                                                {% if car.images.count > 1 %}
                                                    <span class="absolute bottom-1 right-1 bg-black/60 text-white text-[10px] px-1.5 rounded-full backdrop-blur-sm">
                                                        +{{ car.images.count|add:"-1" }}
                                                    </span>
                                                {% endif %}
                                            {% else %}
                                                <div class="h-20 w-32 bg-gray-200 rounded-lg flex items-center justify-center text-xs text-gray-500 group-hover:bg-gray-300 transition">{% trans "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ" %}</div>
                                            {% endif %}
                                            
                                            <div class="absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 transition">
                                                <i class="fas fa-external-link-alt text-white drop-shadow-md"></i>
                                            </div>
                                        </a>
                                    </td>

                                    <td class="p-4 align-top">
                                        <a href="{% url 'car_detail' car.id %}" target="_blank" class="font-bold text-gray-800 text-lg hover:text-[#47B3C4] transition block">
                                            {{ car.brand }} {{ car.model }} <i class="fas fa-external-link-alt text-xs ml-1 opacity-50"></i>
                                        </a>
                                        
                                        <div class="text-gray-500 text-xs mt-1 bg-gray-100 inline-block px-2 py-0.5 rounded">{{ car.license_plate }}</div>
                                        <div class="text-xs text-gray-400 mt-1">{% trans "‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó:" %} {{ car.car_type|default:"‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏" }}</div>
                                    </td>

                                    <td class="p-4">
                                        {% if car.status == 'PENDING' %}
                                            <span class="px-2 py-1 rounded bg-yellow-100 text-yellow-700 text-xs font-bold flex items-center w-max"><i class="fas fa-clock mr-1"></i> {% trans "‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥" %}</span>
                                        {% elif car.status == 'REJECTED' %}
                                            <div class="flex flex-col items-start gap-1">
                                                <span class="px-2 py-1 rounded bg-red-100 text-red-700 text-xs font-bold flex items-center w-max">
                                                    <i class="fas fa-times-circle mr-1"></i> {% trans "‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥" %}
                                                </span>
                                                
                                            </div>
                                        {% elif car.status == 'MAINTENANCE' %}
                                            <span class="px-2 py-1 rounded bg-gray-200 text-gray-600 text-xs font-bold flex items-center w-max"><i class="fas fa-tools mr-1"></i> {% trans "‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á" %}</span>
                                        {% else %}
                                            {% if car.active_booking_count > 0 %}
                                                <span class="px-2 py-1 rounded bg-blue-100 text-blue-700 text-xs font-bold flex items-center w-max"><i class="fas fa-car mr-1"></i> {% trans "‡∏ñ‡∏π‡∏Å‡πÄ‡∏ä‡πà‡∏≤‡∏≠‡∏¢‡∏π‡πà" %}</span>
                                            {% else %}
                                                <span class="px-2 py-1 rounded bg-green-100 text-green-700 text-xs font-bold flex items-center w-max"><i class="fas fa-check mr-1"></i> {% trans "‡∏ß‡πà‡∏≤‡∏á" %}</span>
                                            {% endif %}
                                        {% endif %}
                                    </td>
                                    <td class="p-4 text-gray-600">
                                        <div class="mb-1"><i class="fas fa-calendar-check mr-2 text-gray-400"></i> {% blocktrans with count=car.booking_count %}{{ count }} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á{% endblocktrans %}</div>
                                        <div class="text-green-600 font-bold"><i class="fas fa-coins mr-2"></i> ‡∏ø{{ car.total_income|intcomma }}</div>
                                    </td>
                                    <td class="p-4 text-right space-x-2 align-top">
                                        <div id="images-data-{{ car.id }}" class="hidden">
                                            {% for img in car.images.all %}
                                                <div data-id="{{ img.id }}" data-url="{{ img.image.url }}"></div>
                                            {% endfor %}
                                        </div>

                                        <button onclick="openEditModal(this)" 
                                                data-id="{{ car.id }}" 
                                                data-brand="{{ car.brand }}" 
                                                data-model="{{ car.model }}" 
                                                data-license="{{ car.license_plate }}" 
                                                data-price="{{ car.price_per_day|floatformat:0 }}" 
                                                data-status="{{ car.status }}"
        
                                                data-active-count="{{ car.active_booking_count }}"
                                                data-deposit="{{ car.deposit|default:'0'|floatformat:0 }}" 
                                                data-rules="{{ car.rules|default:''|escape }}"  data-desc="{{ car.description|default:''|escape }}" data-status="{{ car.status }}" 
                                                class="text-blue-500 hover:bg-blue-50 p-2 rounded transition" title="{% trans '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç' %}">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        {% trans "‚ö†Ô∏è ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö‡∏£‡∏ñ‡∏Ñ‡∏±‡∏ô‡∏ô‡∏µ‡πâ?\n‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡πÅ‡∏•‡∏∞‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏£‡∏ñ‡∏Ñ‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏´‡∏≤‡∏¢‡πÑ‡∏õ‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö" as delete_msg %}
                                        {% if car.active_booking_count > 0 %}
                                            <button type="button" disabled class="text-gray-300 cursor-not-allowed p-2" title="{% trans '‡∏£‡∏ñ‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡∏π‡πà ‡∏•‡∏ö‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ' %}">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        {% else %}
                                            <form method="POST" action="{% url 'dashboard' %}" class="inline-block" 
                                                onsubmit="return confirm('{{ delete_msg|escapejs }}');">
                                                {% csrf_token %}
                                                <input type="hidden" name="delete_car_id" value="{{ car.id }}">
                                                <button type="submit" class="text-red-500 hover:bg-red-50 p-2 rounded transition" title="{% trans '‡∏•‡∏ö' %}">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </form>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% empty %}
                                <tr><td colspan="5" class="p-8 text-center text-gray-400">{% trans "‡∏Ñ‡∏∏‡∏ì‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏ñ‡πÄ‡∏ä‡πà‡∏≤ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏ñ‡∏Ñ‡∏±‡∏ô‡πÅ‡∏£‡∏Å‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢!" %}</td></tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>

                <div id="section-bookings" class="tab-content hidden fade-in">
                    <div class="flex justify-between items-center mb-6 border-l-4 border-yellow-500 pl-4">
                        <h2 class="text-xl font-bold text-gray-800">{% trans "‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏£‡∏ñ (1 ‡∏õ‡∏µ‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á)" %}</h2>
                    </div>
                    <div class="h-96 w-full p-4 border border-gray-100 rounded-lg">
                        <canvas id="bookingsChart"></canvas>
                    </div>
                </div>

                <div id="section-revenue" class="tab-content hidden fade-in">
                    <div class="flex justify-between items-center mb-6 border-l-4 border-green-500 pl-4">
                        <h2 class="text-xl font-bold text-gray-800">{% trans "‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ (1 ‡∏õ‡∏µ‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á)" %}</h2>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div class="p-4 border border-gray-100 rounded-lg">
                            <h3 class="text-sm font-bold text-gray-500 mb-4 text-center">{% trans "‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏£‡∏ñ)" %}</h3>
                            <div class="h-64"><canvas id="revenueChart"></canvas></div>
                        </div>
                        <div class="p-4 border border-gray-100 rounded-lg">
                            <h3 class="text-sm font-bold text-gray-500 mb-4 text-center">{% trans "‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏£‡∏ß‡∏°" %}</h3>
                            <div class="h-64 flex justify-center"><canvas id="typeChart"></canvas></div>
                        </div>
                    </div>
                </div>

                <div id="section-insights" class="tab-content hidden fade-in">
                    <div class="flex justify-between items-center mb-6 border-l-4 border-red-500 pl-4">
                        <h2 class="text-xl font-bold text-gray-800">{% trans "‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ" %}</h2>
                    </div>
                    
                    {% if recommendations %}
                    <div class="grid gap-4">
                        {% for rec in recommendations %}
                        <div class="bg-gradient-to-r from-yellow-50 to-white border border-yellow-200 p-6 rounded-xl flex items-start shadow-sm hover:shadow-md transition">
                            <div class="bg-yellow-100 p-3 rounded-full mr-4 text-yellow-600">
                                <i class="fas fa-lightbulb text-2xl"></i>
                            </div>
                            <div>
                                <h4 class="font-bold text-gray-800 text-lg mb-1">{% blocktrans with number=forloop.counter %}‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏ó‡∏µ‡πà {{ number }}{% endblocktrans %}</h4>
                                <p class="text-gray-600 leading-relaxed">{{ rec }}</p>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="text-center p-12 text-gray-400 bg-gray-50 rounded-xl border border-dashed border-gray-300">
                        <i class="fas fa-check-circle text-5xl text-green-400 mb-4"></i>
                        <p class="text-lg">{% trans "‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û‡∏£‡∏ñ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏¢‡∏≠‡∏î‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß!" %}</p>
                        <p class="text-sm">{% trans "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡πÉ‡∏ô‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ" %}</p>
                    </div>
                    {% endif %}
                </div>

            </div>
        </main>
    </div>

    <div id="editModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center transition-opacity duration-300 backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl mx-4 overflow-hidden transform scale-95 transition-transform duration-300" id="modalContent">
            <div class="bg-gradient-to-r from-[#47B3C4] to-[#3a9faa] px-6 py-4 flex justify-between items-center text-white">
                <h2 class="text-xl font-bold"><i class="fas fa-edit mr-2"></i> {% trans "‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏ñ" %}</h2>
                <button type="button" onclick="closeEditModal()" class="text-white hover:text-gray-200 text-2xl font-bold">&times;</button>
            </div>
            <form id="editForm" method="POST" enctype="multipart/form-data" class="flex-1 overflow-y-auto p-6 space-y-6">
                {% csrf_token %}
                <input type="hidden" name="edit_car_id" id="edit_car_id_input">
                
                <div class="flex flex-col md:flex-row gap-6">
                    <div class="w-full md:w-1/3 space-y-3">

                        <label class="block text-sm font-medium text-gray-700">{% trans "‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏£‡∏ñ" %}</label>
                        
                        <div id="current_images_container" class="grid grid-cols-2 gap-2 mb-2">
                            </div>
                        
                        <div class="relative group cursor-pointer w-full h-32 border-2 border-dashed border-gray-300 rounded-lg flex flex-col items-center justify-center hover:border-[#47B3C4] hover:bg-blue-50 transition">
                            <i class="fas fa-cloud-upload-alt text-2xl text-gray-400 group-hover:text-[#47B3C4] mb-1"></i>
                            <span class="text-xs text-gray-500">{% trans "‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏π‡∏õ‡πÉ‡∏´‡∏°‡πà (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏´‡∏•‡∏≤‡∏¢‡∏£‡∏π‡∏õ)" %}</span>
                            <input type="file" name="new_images" id="new_images" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" accept="image/*" multiple onchange="previewNewImages(this)">
                        </div>
                        <div id="new_images_preview" class="grid grid-cols-3 gap-1"></div>
                    </div>

                    <div class="w-full md:w-2/3 space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs text-gray-500 mb-1">{% trans "‡∏¢‡∏µ‡πà‡∏´‡πâ‡∏≠" %}</label>
                                <input type="text" name="brand" id="modal_brand" class="w-full border p-2 rounded bg-gray-100 text-gray-600" readonly>
                            </div>
                            <div>
                                <label class="block text-xs text-gray-500 mb-1">{% trans "‡∏£‡∏∏‡πà‡∏ô" %}</label>
                                <input type="text" name="model" id="modal_model" class="w-full border p-2 rounded bg-gray-100 text-gray-600" readonly>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-xs text-gray-500 mb-1">{% trans "‡πÄ‡∏•‡∏Ç‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô" %}</label>
                            <input type="text" name="license_plate" id="modal_license" class="w-full border border-gray-300 rounded p-2">
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs text-gray-500 mb-1">{% trans "‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≠‡∏ß‡∏±‡∏ô (‡∏ø)" %}</label>
                                <input type="number" name="price" id="modal_price" class="w-full border border-gray-300 rounded p-2 font-bold text-green-600">
                            </div>
                            <div>
                                <label class="block text-xs text-gray-500 mb-1 text-yellow-700">{% trans "‡∏Ñ‡πà‡∏≤‡∏°‡∏±‡∏î‡∏à‡∏≥ (‡∏ø)" %}</label>
                                <input type="number" name="deposit" id="modal_deposit" class="w-full border border-yellow-300 rounded p-2 font-bold text-yellow-700 bg-yellow-50">
                            </div>
                        </div>

                        <div>
                            <label class="block text-xs text-gray-500 mb-1">{% trans "‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°" %}</label>
                            <textarea name="description" id="modal_desc" rows="3" class="w-full border border-gray-300 rounded p-2 text-sm"></textarea>
                        </div>

                        <div>
                            <label class="block text-xs text-red-500 mb-1">{% trans "üö´ ‡∏Å‡∏é‡∏Ç‡πâ‡∏≠‡∏´‡πâ‡∏≤‡∏° / ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç" %}</label>
                            <textarea name="rules" id="modal_rules" rows="3" class="w-full border border-red-200 rounded p-2 bg-red-50 text-sm text-red-800" placeholder="{% trans '‡πÄ‡∏ä‡πà‡∏ô ‡∏´‡πâ‡∏≤‡∏°‡∏™‡∏π‡∏ö‡∏ö‡∏∏‡∏´‡∏£‡∏µ‡πà, ‡∏´‡πâ‡∏≤‡∏°‡∏™‡∏±‡∏ï‡∏ß‡πå‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á' %}"></textarea>
                        </div>

                        <div>
                            <label class="block text-xs text-gray-500 mb-1">{% trans "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞" %}</label>
                            <select name="status" id="modal_status" class="w-full border border-gray-300 rounded p-2">
                                <option value="AVAILABLE">‚úÖ {% trans "‡∏ß‡πà‡∏≤‡∏á (‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô)" %}</option>
                                <option value="MAINTENANCE">üîß {% trans "‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏á (‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á)" %}</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="flex justify-end gap-3 pt-4 border-t sticky bottom-0 bg-white">
                    <button type="button" onclick="closeEditModal()" class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300">{% trans "‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å" %}</button>
                    <button type="submit" class="px-6 py-2 bg-[#47B3C4] text-white rounded hover:bg-[#3a9faa] shadow">{% trans "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å" %}</button>
                </div>
            </form>
        </div>
    </div>

    {{ month_labels|json_script:"month_labels_data" }}
    {{ multi_line_data|json_script:"multi_line_data_data" }} 
    {{ stacked_revenue_data|json_script:"stacked_revenue_data_data" }} 
    {{ type_labels|json_script:"type_labels_data" }}
    {{ type_data|json_script:"type_data_data" }}
    {{ type_colors|json_script:"type_colors_data" }}

    <script>
        // --- 1. Logic ‡∏™‡∏•‡∏±‡∏ö Tab (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°) ---
        function showSection(sectionId, cardElement) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.getElementById('section-' + sectionId).classList.remove('hidden');
            
            document.querySelectorAll('[id^="card-"]').forEach(el => {
                el.classList.remove('ring-2', 'ring-opacity-40'); 
                el.classList.add('border-transparent');
                el.classList.remove('border-[#47B3C4]', 'ring-[#47B3C4]', 'border-[#EAB308]', 'ring-[#EAB308]', 'border-[#22c55e]', 'ring-[#22c55e]', 'border-[#ef4444]', 'ring-[#ef4444]');
            });

            cardElement.classList.remove('border-transparent');
            cardElement.classList.add('ring-2', 'ring-opacity-40');

            if (sectionId === 'cars') cardElement.classList.add('border-[#47B3C4]', 'ring-[#47B3C4]');
            if (sectionId === 'bookings') cardElement.classList.add('border-[#EAB308]', 'ring-[#EAB308]');
            if (sectionId === 'revenue') cardElement.classList.add('border-[#22c55e]', 'ring-[#22c55e]');
            if (sectionId === 'insights') cardElement.classList.add('border-[#ef4444]', 'ring-[#ef4444]');
        }

        // --- 2. Logic Chart.js ---
        document.addEventListener('DOMContentLoaded', function() {
            const monthLabels = JSON.parse(document.getElementById('month_labels_data').textContent);
            const multiLineData = JSON.parse(document.getElementById('multi_line_data_data').textContent);
            const stackedRevenueData = JSON.parse(document.getElementById('stacked_revenue_data_data').textContent); 
            const typeLabels = JSON.parse(document.getElementById('type_labels_data').textContent);
            const typeData = JSON.parse(document.getElementById('type_data_data').textContent);
            const typeColors = JSON.parse(document.getElementById('type_colors_data').textContent);

            // Chart 1: Bookings (Multi-Line Chart)
            if (document.getElementById('bookingsChart')) {
                new Chart(document.getElementById('bookingsChart'), {
                    type: 'line',
                    data: {
                        labels: monthLabels.length ? monthLabels : ['‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'],
                        datasets: multiLineData.length ? multiLineData : [{ label: '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', data: [0], borderColor: '#ccc' }]
                    },
                    options: { 
                        responsive: true, 
                        maintainAspectRatio: false,
                        interaction: { mode: 'index', intersect: false },
                        plugins: { legend: { position: 'top' } },
                        scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }
                    }
                });
            }

            // Chart 2: Revenue (Stacked Bar Chart)
            if (document.getElementById('revenueChart')) {
                new Chart(document.getElementById('revenueChart'), {
                    type: 'bar',
                    data: {
                        labels: monthLabels.length ? monthLabels : ['‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'],
                        datasets: stackedRevenueData.length ? stackedRevenueData : [{
                            label: '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•',
                            data: [0],
                            backgroundColor: '#eee'
                        }]
                    },
                    options: { 
                        responsive: true, 
                        maintainAspectRatio: false,
                        plugins: { 
                            legend: { position: 'top' },
                            tooltip: {
                                mode: 'index',
                                intersect: false,
                                callbacks: {
                                    footer: function(tooltipItems) {
                                        let total = 0;
                                        tooltipItems.forEach(function(item) {
                                            total += item.raw;
                                        });
                                        return '‡∏£‡∏ß‡∏°: ‡∏ø' + total.toLocaleString();
                                    }
                                }
                            }
                        },
                        scales: {
                            x: { stacked: true },
                            y: { stacked: true, beginAtZero: true }
                        }
                    }
                });
            }

            // Chart 3: Types (Doughnut Chart)
            if (document.getElementById('typeChart')) {
                new Chart(document.getElementById('typeChart'), {
                    type: 'doughnut',
                    data: {
                        labels: typeLabels.length ? typeLabels : ['‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'],
                        datasets: [{
                            data: typeData.length ? typeData : [1],
                            backgroundColor: typeColors.length ? typeColors : ['#eee'], 
                            borderWidth: 0,
                            hoverOffset: 10
                        }]
                    },
                    options: { 
                        responsive: true, 
                        maintainAspectRatio: false,
                        plugins: { legend: { position: 'bottom' } } 
                    }
                });
            }
        });

        // --- 3. Modal Logic ---
        const modal = document.getElementById('editModal');
        const modalContent = document.getElementById('modalContent');
        function openEditModal(button) {
            const d = button.dataset;
            document.getElementById('edit_car_id_input').value = button.dataset.id;
            document.getElementById('modal_brand').value = button.dataset.brand;
            document.getElementById('modal_model').value = button.dataset.model;
            document.getElementById('modal_license').value = button.dataset.license;
            document.getElementById('modal_price').value = button.dataset.price;
            document.getElementById('modal_desc').value = button.dataset.desc;
            document.getElementById('modal_rules').value = d.rules || '';     
            document.getElementById('modal_deposit').value = d.deposit || '0';
            
            const statusSelect = document.getElementById('modal_status');
            const status = button.dataset.status;

            // üî• ‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏≤‡∏á‡∏≠‡∏¢‡∏π‡πà
            const activeCount = parseInt(button.dataset.activeCount || 0);

            statusSelect.innerHTML = '';

            if (status === 'PENDING') {
                // ‡∏Å‡∏£‡∏ì‡∏µ 1: ‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö -> ‡∏´‡πâ‡∏≤‡∏°‡πÅ‡∏ï‡∏∞‡∏ï‡πâ‡∏≠‡∏á
                statusSelect.innerHTML = `<option value="PENDING">‚è≥ {% trans "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö" %}</option>`;
                statusSelect.disabled = true;
                statusSelect.className = 'w-full border border-gray-300 rounded p-2 bg-gray-100 cursor-not-allowed text-gray-500';
            
            } else if (status === 'REJECTED') {
                // ‡∏Å‡∏£‡∏ì‡∏µ 2: ‡πÇ‡∏î‡∏ô‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò -> ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÇ‡∏ä‡∏ß‡πå‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏™‡πà‡∏á‡πÉ‡∏´‡∏°‡πà
                // (Backend ‡∏à‡∏∞‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô PENDING ‡πÉ‡∏´‡πâ‡πÄ‡∏≠‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å)
                statusSelect.innerHTML = `<option value="PENDING">üîÑ {% trans "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡πà‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÉ‡∏´‡∏°‡πà" %}</option>`;
                statusSelect.disabled = true; // ‡∏•‡πá‡∏≠‡∏Å‡πÑ‡∏ß‡πâ‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏≠‡∏∑‡πà‡∏ô
                statusSelect.className = 'w-full border border-orange-300 rounded p-2 bg-orange-50 text-orange-700 font-bold';
            
            } else {
                // ‚úÖ ‡∏Å‡∏£‡∏ì‡∏µ 3: (AVAILABLE / MAINTENANCE)
                
                if (activeCount > 0) {
                    // üîí ‡∏ñ‡πâ‡∏≤‡∏£‡∏ñ‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏á (‡∏°‡∏µ Booking ‡∏Ñ‡πâ‡∏≤‡∏á) -> ‡∏•‡πá‡∏≠‡∏Å‡∏´‡πâ‡∏≤‡∏°‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
                    statusSelect.innerHTML = `<option value="${status}">üö´ {% trans "‡∏£‡∏ñ‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡∏π‡πà (‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ)" %}</option>`;
                    statusSelect.disabled = true;
                    statusSelect.className = 'w-full border border-red-300 rounded p-2 bg-red-50 text-red-700 font-bold cursor-not-allowed';
                } else {
                    // üîì ‡∏ñ‡πâ‡∏≤‡∏£‡∏ñ‡∏ß‡πà‡∏≤‡∏á‡∏à‡∏£‡∏¥‡∏á‡πÜ -> ‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏õ‡∏Å‡∏ï‡∏¥
                    statusSelect.innerHTML = `
                        <option value="AVAILABLE">‚úÖ {% trans "‡∏ß‡πà‡∏≤‡∏á (‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô)" %}</option>
                        <option value="MAINTENANCE">üîß {% trans "‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏á (‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á)" %}</option>
                    `;
                    statusSelect.value = status;
                    statusSelect.disabled = false;
                    statusSelect.className = 'w-full border border-gray-300 rounded p-2 bg-white text-gray-800';
                }
            }
            
            const imgContainer = document.getElementById('current_images_container');
            imgContainer.innerHTML = ''; 
            
            const hiddenImagesDiv = document.getElementById('images-data-' + d.id);
            const images = hiddenImagesDiv.querySelectorAll('div');

            if (images.length > 0) {
                images.forEach(img => {
                    const imgId = img.dataset.id;
                    const imgUrl = img.dataset.url;
                    
                    const wrapper = document.createElement('div');
                    wrapper.className = 'relative group h-20 w-full border rounded overflow-hidden';
                    wrapper.innerHTML = `
                        <img src="${imgUrl}" class="w-full h-full object-cover">
                        <label class="absolute inset-0 bg-red-500/80 flex items-center justify-center opacity-0 group-hover:opacity-100 transition cursor-pointer text-white text-xs font-bold">
                            <input type="checkbox" name="delete_images" value="${imgId}" class="mr-1"> ‡∏•‡∏ö
                        </label>
                    `;
                    imgContainer.appendChild(wrapper);
                });
            } else {
                imgContainer.innerHTML = '<p class="text-gray-400 text-xs col-span-2 text-center py-2">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÄ‡∏î‡∏¥‡∏°</p>';
            }

            document.getElementById('new_images').value = '';
            document.getElementById('new_images_preview').innerHTML = '';

            modal.classList.remove('hidden');
            setTimeout(() => { modalContent.classList.remove('scale-95'); modalContent.classList.add('scale-100'); }, 10);
        }
        
        function closeEditModal() {
            modalContent.classList.remove('scale-100'); modalContent.classList.add('scale-95');
            setTimeout(() => { modal.classList.add('hidden'); }, 300);
        }

        function previewNewImages(input) {
            const container = document.getElementById('new_images_preview');
            container.innerHTML = ''; 

            if (input.files) {
                Array.from(input.files).forEach(file => {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const div = document.createElement('div');
                        div.className = 'h-10 w-full rounded border border-green-300 overflow-hidden relative';
                        div.innerHTML = `<img src="${e.target.result}" class="w-full h-full object-cover">`;
                        container.appendChild(div);
                    }
                    reader.readAsDataURL(file);
                });
            }
        }

        window.onclick = function(event) { if (event.target == modal) { closeEditModal(); } }
    
    </script>
</body>
</html>