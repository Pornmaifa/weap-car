{% load static %}
{% load humanize %}
<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Owner Dashboard - WarpCar</title>
    <link href="{% static 'dist/styles.css' %}?v=4" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body class="bg-gray-100 font-sarabun">

    {% include 'car_rental/navbar_detail.html' %}

    <div class="container mx-auto flex flex-col md:flex-row p-4 md:p-8 gap-8">
         {% include 'users/sidebar.html' %}
            
        <main class="flex-1 p-4 md:p-8 fade-in">
            
            <div class="flex items-center justify-between mb-6">
                <div>
                    <h1 class="text-3xl font-bold text-gray-800">Owner Dashboard</h1>
                    <p class="text-gray-500 mt-1">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏ñ‡πÄ‡∏ä‡πà‡∏≤‡πÅ‡∏•‡∏∞‡∏î‡∏π‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</p>
                </div>
                <a href="{% url 'add_car' %}" class="bg-[#47B3C4] hover:bg-[#3a9faa] text-white px-4 py-2 rounded shadow flex items-center gap-2 font-medium transition transform hover:scale-105">
                    <i class="fas fa-plus"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏ñ‡πÉ‡∏´‡∏°‡πà
                </a>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                <div onclick="showSection('cars', this)" id="card-cars" class="bg-white p-6 rounded-lg shadow cursor-pointer border-b-4 border-[#47B3C4] ring-2 ring-[#47B3C4] ring-opacity-40 transition hover:shadow-lg">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-sm text-gray-500 font-semibold mb-1">‡∏£‡∏ñ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>
                            <p class="text-3xl font-bold text-gray-800">{{ total_cars|intcomma }}</p>
                        </div>
                        <div class="p-3 bg-blue-50 rounded-full text-[#47B3C4]"><i class="fas fa-car text-xl"></i></div>
                    </div>
                </div>

                <div onclick="showSection('bookings', this)" id="card-bookings" class="bg-white p-6 rounded-lg shadow cursor-pointer border-b-4 border-transparent hover:border-[#EAB308] transition hover:shadow-lg">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-sm text-gray-500 font-semibold mb-1">‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>
                            <p class="text-3xl font-bold text-gray-800">{{ total_bookings|intcomma }}</p>
                            <p class="text-xs text-gray-400 mt-1 font-medium">
                                <i class="far fa-clock mr-1"></i> ‡∏£‡∏ß‡∏° {{ total_days_booked|intcomma }} ‡∏ß‡∏±‡∏ô
                            </p>
                        </div>
                        <div class="p-3 bg-yellow-50 rounded-full text-yellow-600"><i class="fas fa-bookmark text-xl"></i></div>
                    </div>
                </div>

                <div onclick="showSection('revenue', this)" id="card-revenue" class="bg-white p-6 rounded-lg shadow cursor-pointer border-b-4 border-transparent hover:border-[#22c55e] transition hover:shadow-lg">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-sm text-gray-500 font-semibold mb-1">‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏£‡∏ß‡∏°</p>
                            <p class="text-3xl font-bold text-green-600">‡∏ø{{ total_revenue|intcomma }}</p>
                        </div>
                        <div class="p-3 bg-green-50 rounded-full text-green-600"><i class="fas fa-wallet text-xl"></i></div>
                    </div>
                </div>

                <div onclick="showSection('insights', this)" id="card-insights" class="bg-white p-6 rounded-lg shadow cursor-pointer border-b-4 border-transparent hover:border-[#ef4444] transition hover:shadow-lg relative overflow-hidden">
                    <div class="flex justify-between items-start z-10 relative">
                        <div>
                            <p class="text-sm text-gray-500 font-semibold mb-1">AI ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥</p>
                            <p class="text-lg font-bold text-gray-800">{{ recommendations|length }} ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°</p>
                        </div>
                        <div class="p-3 bg-red-50 rounded-full text-red-500"><i class="fas fa-lightbulb text-xl"></i></div>
                    </div>
                    {% if recommendations %}
                        <div class="absolute top-2 right-2 w-2 h-2 bg-red-500 rounded-full animate-ping"></div>
                    {% endif %}
                </div>
            </div>

            <div class="bg-white rounded-lg shadow-lg p-6 min-h-[500px] transition-all">

                <div id="section-cars" class="tab-content fade-in">
                    <div class="flex justify-between items-center mb-6 border-l-4 border-[#47B3C4] pl-4">
                        <h2 class="text-xl font-bold text-gray-800">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏ñ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</h2>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left border-collapse">
                            <thead class="bg-gray-50 text-gray-600 uppercase border-b">
                                <tr>
                                    <th class="p-4 rounded-tl-lg">‡∏£‡∏π‡∏õ‡∏£‡∏ñ</th>
                                    <th class="p-4">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</th>
                                    <th class="p-4">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                                    <th class="p-4">‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥</th>
                                    <th class="p-4 text-right rounded-tr-lg">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y">
                                {% for car in cars %}
                                <tr class="hover:bg-gray-50 transition duration-150">
                                    <td class="p-4 w-24">
                                        {% if car.images.all %}
                                            <img src="{{ car.images.first.image.url }}" class="h-16 w-24 object-cover rounded-lg shadow-sm border border-gray-200">
                                        {% else %}
                                            <div class="h-16 w-24 bg-gray-200 rounded-lg flex items-center justify-center text-xs text-gray-500">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ</div>
                                        {% endif %}
                                    </td>
                                    <td class="p-4">
                                        <div class="font-bold text-gray-800 text-lg">{{ car.brand }} {{ car.model }}</div>
                                        <div class="text-gray-500 text-xs mt-1 bg-gray-100 inline-block px-2 py-0.5 rounded">{{ car.license_plate }}</div>
                                        <div class="text-[#47B3C4] font-bold mt-1">‡∏ø{{ car.price_per_day|intcomma }}/‡∏ß‡∏±‡∏ô</div>
                                        <div class="text-xs text-gray-400 mt-1">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó: {{ car.car_type|default:"‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏" }}</div>
                                    </td>
                                    <td class="p-4">
                                        {% if car.status == 'PENDING' %}
                                            <span class="px-2 py-1 rounded bg-yellow-100 text-yellow-700 text-xs font-bold flex items-center w-max"><i class="fas fa-clock mr-1"></i> ‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</span>
                                        {% elif car.status == 'MAINTENANCE' %}
                                            <span class="px-2 py-1 rounded bg-gray-200 text-gray-600 text-xs font-bold flex items-center w-max"><i class="fas fa-tools mr-1"></i> ‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á</span>
                                        {% else %}
                                            {% if car.active_booking_count > 0 %}
                                                <span class="px-2 py-1 rounded bg-blue-100 text-blue-700 text-xs font-bold flex items-center w-max"><i class="fas fa-car mr-1"></i> ‡∏ñ‡∏π‡∏Å‡πÄ‡∏ä‡πà‡∏≤‡∏≠‡∏¢‡∏π‡πà</span>
                                            {% else %}
                                                <span class="px-2 py-1 rounded bg-green-100 text-green-700 text-xs font-bold flex items-center w-max"><i class="fas fa-check mr-1"></i> ‡∏ß‡πà‡∏≤‡∏á</span>
                                            {% endif %}
                                        {% endif %}
                                    </td>
                                    <td class="p-4 text-gray-600">
                                        <div class="mb-1"><i class="fas fa-calendar-check mr-2 text-gray-400"></i> {{ car.booking_count }} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</div>
                                        <div class="text-green-600 font-bold"><i class="fas fa-coins mr-2"></i> ‡∏ø{{ car.total_income|intcomma }}</div>
                                    </td>
                                    <td class="p-4 text-right space-x-2">
                                        <button onclick="openEditModal(this)" 
                                                data-id="{{ car.id }}" 
                                                data-brand="{{ car.brand }}" 
                                                data-model="{{ car.model }}" 
                                                data-license="{{ car.license_plate }}" 
                                                data-price="{{ car.price_per_day|floatformat:0 }}" 
                                                data-desc="{{ car.description }}" 
                                                data-status="{{ car.status }}" 
                                                data-img="{% if car.images.all %}{{ car.images.first.image.url }}{% endif %}" 
                                                class="text-blue-500 hover:bg-blue-50 p-2 rounded transition" title="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <form method="POST" action="{% url 'dashboard' %}" class="inline-block" onsubmit="return confirm('‚ö†Ô∏è ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö‡∏£‡∏ñ‡∏Ñ‡∏±‡∏ô‡∏ô‡∏µ‡πâ?\n‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡πÅ‡∏•‡∏∞‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏£‡∏ñ‡∏Ñ‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏´‡∏≤‡∏¢‡πÑ‡∏õ‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö');">
                                            {% csrf_token %}
                                            <input type="hidden" name="delete_car_id" value="{{ car.id }}">
                                            <button type="submit" class="text-red-500 hover:bg-red-50 p-2 rounded transition" title="‡∏•‡∏ö">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </form>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr><td colspan="5" class="p-8 text-center text-gray-400">‡∏Ñ‡∏∏‡∏ì‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏ñ‡πÄ‡∏ä‡πà‡∏≤ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏ñ‡∏Ñ‡∏±‡∏ô‡πÅ‡∏£‡∏Å‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢!</td></tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>

                <div id="section-bookings" class="tab-content hidden fade-in">
                    <div class="flex justify-between items-center mb-6 border-l-4 border-yellow-500 pl-4">
                        <h2 class="text-xl font-bold text-gray-800">‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏£‡∏ñ</h2>
                    </div>
                    <div class="h-96 w-full p-4 border border-gray-100 rounded-lg">
                        <canvas id="bookingsChart"></canvas>
                    </div>
                </div>

                <div id="section-revenue" class="tab-content hidden fade-in">
                    <div class="flex justify-between items-center mb-6 border-l-4 border-green-500 pl-4">
                        <h2 class="text-xl font-bold text-gray-800">‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ</h2>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div class="p-4 border border-gray-100 rounded-lg">
                            <h3 class="text-sm font-bold text-gray-500 mb-4 text-center">‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (‡∏ö‡∏≤‡∏ó)</h3>
                            <div class="h-64"><canvas id="revenueChart"></canvas></div>
                        </div>
                        <div class="p-4 border border-gray-100 rounded-lg">
                            <h3 class="text-sm font-bold text-gray-500 mb-4 text-center">‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏£‡∏ñ</h3>
                            <div class="h-64 flex justify-center"><canvas id="typeChart"></canvas></div>
                        </div>
                    </div>
                </div>

                <div id="section-insights" class="tab-content hidden fade-in">
                    <div class="flex justify-between items-center mb-6 border-l-4 border-red-500 pl-4">
                        <h2 class="text-xl font-bold text-gray-800">‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ</h2>
                    </div>
                    
                    {% if recommendations %}
                    <div class="grid gap-4">
                        {% for rec in recommendations %}
                        <div class="bg-gradient-to-r from-yellow-50 to-white border border-yellow-200 p-6 rounded-xl flex items-start shadow-sm hover:shadow-md transition">
                            <div class="bg-yellow-100 p-3 rounded-full mr-4 text-yellow-600">
                                <i class="fas fa-lightbulb text-2xl"></i>
                            </div>
                            <div>
                                <h4 class="font-bold text-gray-800 text-lg mb-1">‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏ó‡∏µ‡πà {{ forloop.counter }}</h4>
                                <p class="text-gray-600 leading-relaxed">{{ rec }}</p>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="text-center p-12 text-gray-400 bg-gray-50 rounded-xl border border-dashed border-gray-300">
                        <i class="fas fa-check-circle text-5xl text-green-400 mb-4"></i>
                        <p class="text-lg">‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û‡∏£‡∏ñ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏¢‡∏≠‡∏î‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß!</p>
                        <p class="text-sm">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡πÉ‡∏ô‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ</p>
                    </div>
                    {% endif %}
                </div>

            </div>
        </main>
    </div>

    <div id="editModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center transition-opacity duration-300 backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl mx-4 overflow-hidden transform scale-95 transition-transform duration-300" id="modalContent">
            
            <div class="bg-gradient-to-r from-[#47B3C4] to-[#3a9faa] px-6 py-4 flex justify-between items-center text-white">
                <h2 class="text-xl font-bold"><i class="fas fa-edit mr-2"></i> ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏ñ</h2>
                <button type="button" onclick="closeEditModal()" class="text-white hover:text-gray-200 text-2xl font-bold">&times;</button>
            </div>

            <form id="editForm" method="POST" enctype="multipart/form-data" class="p-6 space-y-6">
                {% csrf_token %}
                <input type="hidden" name="edit_car_id" id="edit_car_id_input">
                
                <div class="flex flex-col md:flex-row gap-6">
                    <div class="w-full md:w-1/3 flex flex-col items-center">
                        <div class="w-full h-40 bg-gray-100 border-2 border-dashed border-gray-300 rounded-lg overflow-hidden mb-2 flex items-center justify-center relative group cursor-pointer hover:border-[#47B3C4] transition">
                            <img id="modal_img_preview" src="" class="w-full h-full object-cover hidden">
                            <div id="modal_no_img" class="text-center text-gray-400">
                                <i class="fas fa-camera text-3xl mb-2"></i><br>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ
                            </div>
                            <label for="new_image" class="absolute inset-0 bg-black bg-opacity-50 flex flex-col items-center justify-center text-white opacity-0 group-hover:opacity-100 cursor-pointer transition">
                                <i class="fas fa-upload text-2xl mb-1"></i>
                                <span>‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏π‡∏õ</span>
                            </label>
                        </div>
                        <input type="file" name="new_image" id="new_image" class="hidden" accept="image/*" onchange="previewImage(this)">
                        <p class="text-xs text-gray-500">‡∏Ç‡∏ô‡∏≤‡∏î‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥ 800x600 px</p>
                    </div>

                    <div class="w-full md:w-2/3 space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">‡∏¢‡∏µ‡πà‡∏´‡πâ‡∏≠</label>
                                <input type="text" name="brand" id="modal_brand" class="w-full border border-gray-300 rounded-lg p-2.5 focus:ring-2 focus:ring-[#47B3C4] outline-none transition">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">‡∏£‡∏∏‡πà‡∏ô</label>
                                <input type="text" name="model" id="modal_model" class="w-full border border-gray-300 rounded-lg p-2.5 focus:ring-2 focus:ring-[#47B3C4] outline-none transition">
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">‡πÄ‡∏•‡∏Ç‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</label>
                            <input type="text" name="license_plate" id="modal_license" class="w-full border border-gray-300 rounded-lg p-2.5 focus:ring-2 focus:ring-[#47B3C4] outline-none bg-gray-50">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≠‡∏ß‡∏±‡∏ô (‡∏ö‡∏≤‡∏ó)</label>
                            <div class="relative">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-gray-500">‡∏ø</div>
                                <input type="number" name="price" id="modal_price" class="w-full pl-8 border border-gray-300 rounded-lg p-2.5 focus:ring-2 focus:ring-[#47B3C4] outline-none transition">
                            </div>
                        </div>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</label>
                    <textarea name="description" id="modal_desc" rows="3" class="w-full border border-gray-300 rounded-lg p-2.5 focus:ring-2 focus:ring-[#47B3C4] outline-none transition"></textarea>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏£‡∏ñ</label>
                    <div class="relative">
                        <select name="status" id="modal_status" class="w-full border border-gray-300 rounded-lg p-2.5 focus:ring-2 focus:ring-[#47B3C4] outline-none bg-white appearance-none cursor-pointer">
                            <option value="AVAILABLE">‚úÖ ‡∏ß‡πà‡∏≤‡∏á (‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô)</option>
                            <option value="MAINTENANCE">üîß ‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏á (‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á/‡∏õ‡∏¥‡∏î‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á)</option>
                        </select>
                        <div class="absolute inset-y-0 right-0 flex items-center px-2 pointer-events-none text-gray-500"><i class="fas fa-chevron-down"></i></div>
                    </div>
                </div>

                <div class="flex justify-end gap-3 mt-6 pt-4 border-t">
                    <button type="button" onclick="closeEditModal()" class="px-5 py-2.5 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 font-medium transition">
                        ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                    </button>
                    <button type="submit" class="px-6 py-2.5 bg-[#47B3C4] text-white rounded-lg hover:bg-[#3a9faa] font-medium shadow-md hover:shadow-lg transition transform hover:-translate-y-0.5">
                        <i class="fas fa-save mr-2"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                    </button>
                </div>
            </form>
        </div>
    </div>

    {{ month_labels|json_script:"month_labels_data" }}
    {{ multi_line_data|json_script:"multi_line_data_data" }} {{ revenue_data|json_script:"revenue_data_data" }}
    {{ type_labels|json_script:"type_labels_data" }}
    {{ type_data|json_script:"type_data_data" }}

    <script>
        // --- 1. Logic ‡∏™‡∏•‡∏±‡∏ö Tab ---
        function showSection(sectionId, cardElement) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.getElementById('section-' + sectionId).classList.remove('hidden');
            
            document.querySelectorAll('[id^="card-"]').forEach(el => {
                el.classList.remove('ring-2', 'ring-opacity-40'); 
                el.classList.add('border-transparent');
                el.classList.remove('border-[#47B3C4]', 'ring-[#47B3C4]', 'border-[#EAB308]', 'ring-[#EAB308]', 'border-[#22c55e]', 'ring-[#22c55e]', 'border-[#ef4444]', 'ring-[#ef4444]');
            });

            cardElement.classList.remove('border-transparent');
            cardElement.classList.add('ring-2', 'ring-opacity-40');

            if (sectionId === 'cars') cardElement.classList.add('border-[#47B3C4]', 'ring-[#47B3C4]');
            if (sectionId === 'bookings') cardElement.classList.add('border-[#EAB308]', 'ring-[#EAB308]');
            if (sectionId === 'revenue') cardElement.classList.add('border-[#22c55e]', 'ring-[#22c55e]');
            if (sectionId === 'insights') cardElement.classList.add('border-[#ef4444]', 'ring-[#ef4444]');
        }

        // --- 2. Logic Chart.js ---
        document.addEventListener('DOMContentLoaded', function() {
            const monthLabels = JSON.parse(document.getElementById('month_labels_data').textContent);
            const multiLineData = JSON.parse(document.getElementById('multi_line_data_data').textContent);
            const revenueData = JSON.parse(document.getElementById('revenue_data_data').textContent);
            const typeLabels = JSON.parse(document.getElementById('type_labels_data').textContent);
            const typeData = JSON.parse(document.getElementById('type_data_data').textContent);

            // Chart 1: Bookings (Multi-Line Chart)
            if (document.getElementById('bookingsChart')) {
                new Chart(document.getElementById('bookingsChart'), {
                    type: 'line',
                    data: {
                        labels: monthLabels.length ? monthLabels : ['‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'],
                        datasets: multiLineData.length ? multiLineData : [{ label: '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', data: [0], borderColor: '#ccc' }]
                    },
                    options: { 
                        responsive: true, 
                        maintainAspectRatio: false,
                        interaction: { mode: 'index', intersect: false },
                        plugins: { legend: { position: 'top' } },
                        scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }
                    }
                });
            }

            // Chart 2: Revenue (Bar Chart)
            if (document.getElementById('revenueChart')) {
                new Chart(document.getElementById('revenueChart'), {
                    type: 'bar',
                    data: {
                        labels: monthLabels.length ? monthLabels : ['‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'],
                        datasets: [{
                            label: '‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ (‡∏ö‡∏≤‡∏ó)',
                            data: revenueData.length ? revenueData : [0],
                            backgroundColor: '#22c55e',
                            borderRadius: 6,
                            barThickness: 30
                        }]
                    },
                    options: { 
                        responsive: true, 
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } }
                    }
                });
            }

            // Chart 3: Types (Doughnut Chart)
            if (document.getElementById('typeChart')) {
                new Chart(document.getElementById('typeChart'), {
                    type: 'doughnut',
                    data: {
                        labels: typeLabels.length ? typeLabels : ['‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'],
                        datasets: [{
                            data: typeData.length ? typeData : [1],
                            backgroundColor: ['#47B3C4', '#FF6384', '#FFCE56', '#4BC0C0', '#9966FF'],
                            borderWidth: 0,
                            hoverOffset: 10
                        }]
                    },
                    options: { 
                        responsive: true, 
                        maintainAspectRatio: false,
                        plugins: { legend: { position: 'bottom' } } 
                    }
                });
            }
        });

        // --- 3. Modal Logic ---
        const modal = document.getElementById('editModal');
        const modalContent = document.getElementById('modalContent');

        function openEditModal(button) {
            document.getElementById('edit_car_id_input').value = button.dataset.id;
            document.getElementById('modal_brand').value = button.dataset.brand;
            document.getElementById('modal_model').value = button.dataset.model;
            document.getElementById('modal_license').value = button.dataset.license;
            document.getElementById('modal_price').value = button.dataset.price;
            document.getElementById('modal_desc').value = button.dataset.desc;
            
            const statusSelect = document.getElementById('modal_status');
            const status = button.dataset.status;
            statusSelect.value = status;
            if (status === 'PENDING') {
                statusSelect.disabled = true;
                statusSelect.classList.add('bg-gray-100', 'cursor-not-allowed');
                statusSelect.title = "‡∏ï‡πâ‡∏≠‡∏á‡∏ú‡πà‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏Å‡πà‡∏≠‡∏ô";
            } else {
                statusSelect.disabled = false;
                statusSelect.classList.remove('bg-gray-100', 'cursor-not-allowed');
                statusSelect.title = "";
            }

            const imgUrl = button.dataset.img;
            const imgPreview = document.getElementById('modal_img_preview');
            const noImg = document.getElementById('modal_no_img');
            
            if (imgUrl) {
                imgPreview.src = imgUrl;
                imgPreview.classList.remove('hidden');
                noImg.classList.add('hidden');
            } else {
                imgPreview.classList.add('hidden');
                noImg.classList.remove('hidden');
            }

            modal.classList.remove('hidden');
            setTimeout(() => {
                modalContent.classList.remove('scale-95');
                modalContent.classList.add('scale-100');
            }, 10);
        }

        function closeEditModal() {
            modalContent.classList.remove('scale-100');
            modalContent.classList.add('scale-95');
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 300);
        }

        function previewImage(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('modal_img_preview').src = e.target.result;
                    document.getElementById('modal_img_preview').classList.remove('hidden');
                    document.getElementById('modal_no_img').classList.add('hidden');
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        window.onclick = function(event) {
            if (event.target == modal) { closeEditModal(); }
        }
    </script>

</body>
</html>